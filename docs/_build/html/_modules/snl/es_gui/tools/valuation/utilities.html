<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>snl.es_gui.tools.valuation.utilities &mdash; Quest Documentation 1.6.0 documentation</title>
      <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/underscore.js"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Quest Documentation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Quest Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">snl.es_gui.tools.valuation.utilities</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for snl.es_gui.tools.valuation.utilities</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">xlrd.biffh</span> <span class="kn">import</span> <span class="n">XLRDError</span>


<div class="viewcode-block" id="read_ercot_da_spp"><a class="viewcode-back" href="../../../../../snl.es_gui.tools.valuation.html#snl.es_gui.tools.valuation.utilities.read_ercot_da_spp">[docs]</a><span class="k">def</span> <span class="nf">read_ercot_da_spp</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">settlement_point</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the day-ahead market historical settlement point prices file at fname and returns the NumPy ndarray corresponding to the hourly price at settlement_point.</span>

<span class="sd">    :param fname: string giving location of DAM SPPs file</span>
<span class="sd">    :type fname: str</span>
<span class="sd">    :param month: which month to read data for; (int) [1, 12] OR (str) [&#39;1&#39;, &#39;12&#39;]</span>
<span class="sd">    :type month: int or str</span>
<span class="sd">    :param settlement_point: string giving settlement point name (hub or load zone)</span>
<span class="sd">    :type settlement_point: str</span>
<span class="sd">    :return spp_da: NumPy ndarray with SPPs for month and settlement point</span>
<span class="sd">    :rtype: NumPy ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spp_da</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

    <span class="c1"># if month is provided as an int, map it to the correct calendar month</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">month_abbr</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">month_ix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>        
        <span class="n">month_abbr</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="n">month_ix</span><span class="p">]</span>

    <span class="c1"># Retrieve the correct worksheet for the month.</span>
    <span class="n">wkbk</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelFile</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">wkbk_sheetnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">wkbk</span><span class="o">.</span><span class="n">sheet_names</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">wkst_ix</span> <span class="o">=</span> <span class="n">wkbk_sheetnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">month_abbr</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c1"># The worksheet for the requested month does not exist.</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;read_ercot_da_spp: Could not load data (the specified month of data could not be found in the given file), returning empty array. (got </span><span class="si">{fname}</span><span class="s1">, </span><span class="si">{month}</span><span class="s1">, </span><span class="si">{settlement_point}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">month</span><span class="p">,</span> <span class="n">settlement_point</span><span class="o">=</span><span class="n">settlement_point</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">spp_da</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">wkbk</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">wkst_ix</span><span class="p">)</span>

        <span class="c1"># filter DataFrame by settlement_point and extract series</span>
        <span class="n">df0</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Settlement Point&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">settlement_point</span><span class="p">]</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="n">df0</span><span class="p">[</span><span class="s1">&#39;Settlement Point Price&#39;</span><span class="p">]</span>

        <span class="c1"># convert to NumPy array and remove NaN</span>
        <span class="n">spp_da</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="n">spp_da</span> <span class="o">=</span> <span class="n">spp_da</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">spp_da</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">spp_da</span></div>


<div class="viewcode-block" id="read_ercot_da_ccp"><a class="viewcode-back" href="../../../../../snl.es_gui.tools.valuation.html#snl.es_gui.tools.valuation.utilities.read_ercot_da_ccp">[docs]</a><span class="k">def</span> <span class="nf">read_ercot_da_ccp</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">month</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the day-ahead market historical capacity clearing prices file at fname and returns NumPy ndarrays corresponding to the hourly regdn and regup prices.</span>

<span class="sd">    :param fname: </span>
<span class="sd">    :param month: which month to read data for; (int) [1, 12] OR (str) [&#39;1&#39;, &#39;12&#39;]</span>
<span class="sd">    </span>
<span class="sd">    :param fname: string giving location of DAM CCPs file</span>
<span class="sd">    :type fname: str</span>
<span class="sd">    :param month: which month to read data for; (int) [1, 12] OR (str) [&#39;1&#39;, &#39;12&#39;]</span>
<span class="sd">    :type month: int or str</span>
<span class="sd">    :return: NumPy ndarrays with regdn and regup CCPs for month</span>
<span class="sd">    :rtype: Numpy ndarrays</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">regdn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">regup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

    <span class="c1"># if month is provided as an int, map it to the correct calendar month</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">month_ix</span> <span class="o">=</span> <span class="n">month</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">month_ix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>
    
    <span class="c1"># Read .csv and generate a Series for the month from &quot;Delivery Date&quot; column.</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">series_month</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Delivery Date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>

    <span class="c1"># Filter DataFrame by month.</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">series_month</span> <span class="o">==</span> <span class="n">month_ix</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">regdn</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;REGDN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="n">regdn</span> <span class="o">=</span> <span class="n">regdn</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">regdn</span><span class="p">)]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">regup</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;REGUP &#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># why is there an extra space in the key</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">regup</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;REGUP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">regup</span> <span class="o">=</span> <span class="n">regup</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">regup</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;read_ercot_da_ccp: No data matching input parameters found, returning empty array. (got </span><span class="si">{fname}</span><span class="s1">, </span><span class="si">{month}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">month</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">regdn</span><span class="p">,</span> <span class="n">regup</span></div>


<div class="viewcode-block" id="read_nodeid"><a class="viewcode-back" href="../../../../../snl.es_gui.tools.valuation.html#snl.es_gui.tools.valuation.utilities.read_nodeid">[docs]</a><span class="k">def</span> <span class="nf">read_nodeid</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">iso</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">xlrd</span> <span class="kn">import</span> <span class="n">open_workbook</span>
    <span class="n">wb</span> <span class="o">=</span> <span class="n">open_workbook</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">ws</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">sheet_by_name</span><span class="p">(</span><span class="n">iso</span><span class="p">)</span>
    <span class="n">nodeid</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ws</span><span class="o">.</span><span class="n">nrows</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">cell</span><span class="o">=</span><span class="n">ws</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">text</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.0&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">nodeid</span><span class="o">+=</span><span class="p">[</span><span class="n">text</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">nodeid</span></div>


<div class="viewcode-block" id="read_pjm_data"><a class="viewcode-back" href="../../../../../snl.es_gui.tools.valuation.html#snl.es_gui.tools.valuation.utilities.read_pjm_data">[docs]</a><span class="k">def</span> <span class="nf">read_pjm_data</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">nodeid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">    Reads the historical LMP, regulation capacity, and regulation service (mileage) prices for the year &#39;year&#39;,</span>
<span class="sd">    the month &#39;month&#39; and for the node &#39;nodeid&#39;. Returns NumPy ndarrays for those three prices.</span>

<span class="sd">    :param fpath: The path to the root of the PJM data directory</span>
<span class="sd">    :type fpath: str</span>
<span class="sd">    :param year: Year of data to read</span>
<span class="sd">    :type year: int or str</span>
<span class="sd">    :param month: Month of data to read</span>
<span class="sd">    :type month: int or str</span>
<span class="sd">    :return: daLMP, RegCCP, RegPCP: Hourly LMP and regulation capacity/performance clearing price values.</span>
<span class="sd">    :rtype: NumPy ndarrays</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">daLMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">RegCCP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">RegPCP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">rega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">regd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">mr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">month</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nodeid</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">nodeid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nodeid</span><span class="p">)</span>

    <span class="n">fnameLMP</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:d}{1:02d}</span><span class="s2">_dalmp_</span><span class="si">{2:d}</span><span class="s2">.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">nodeid</span><span class="p">)</span>
    <span class="n">fnameREG</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:d}{1:02d}</span><span class="s2">_regp.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">)</span>
    <span class="n">fnameMILEAGE</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:d}{1:02d}</span><span class="s2">_regm.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">)</span>

    <span class="n">fname_path_LMP</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;LMP&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nodeid</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="n">fnameLMP</span><span class="p">)</span>
    <span class="n">fname_path_REG</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;REG&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="n">fnameREG</span><span class="p">)</span>
    <span class="n">fname_path_MILEAGE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;MILEAGE&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="n">fnameMILEAGE</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">dfLMP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_LMP</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">daLMP</span> <span class="o">=</span> <span class="n">dfLMP</span><span class="p">[</span><span class="s1">&#39;total_lmp_da&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;read_pjm_data: No LMP data matching input parameters found, returning empty array. (got </span><span class="si">{fname}</span><span class="s1">, </span><span class="si">{year}</span><span class="s1">, </span><span class="si">{month}</span><span class="s1">, </span><span class="si">{nodeid}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fnameLMP</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">month</span><span class="p">,</span> <span class="n">nodeid</span><span class="o">=</span><span class="n">nodeid</span><span class="p">))</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dfREG</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_REG</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">RegCCP</span> <span class="o">=</span> <span class="n">dfREG</span><span class="p">[</span><span class="s1">&#39;rmccp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">RegPCP</span> <span class="o">=</span> <span class="n">dfREG</span><span class="p">[</span><span class="s1">&#39;rmpcp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;read_pjm_data: No REG data matching input parameters found, returning empty array. (got </span><span class="si">{fname}</span><span class="s1">, </span><span class="si">{year}</span><span class="s1">, </span><span class="si">{month}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fnameREG</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">month</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">dfMILEAGE</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_MILEAGE</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">dfMILEAGE</span><span class="p">[</span><span class="s1">&#39;MILEAGE RATIO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfMILEAGE</span><span class="p">[</span><span class="s1">&#39;regd_hourly&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">dfMILEAGE</span><span class="p">[</span><span class="s1">&#39;rega_hourly&#39;</span><span class="p">]</span>

        <span class="c1"># TODO: Handling NaNs/missing data intelligently. The current method just fills forward.</span>
        <span class="n">rega</span> <span class="o">=</span> <span class="n">dfMILEAGE</span><span class="p">[</span><span class="s1">&#39;rega_hourly&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="n">regd</span> <span class="o">=</span> <span class="n">dfMILEAGE</span><span class="p">[</span><span class="s1">&#39;regd_hourly&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="n">mr</span> <span class="o">=</span> <span class="n">dfMILEAGE</span><span class="p">[</span><span class="s1">&#39;MILEAGE RATIO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;read_pjm_data: No MILEAGE data matching input parameters found, returning empty array. (got </span><span class="si">{fname}</span><span class="s1">, </span><span class="si">{year}</span><span class="s1">, </span><span class="si">{month}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fnameMILEAGE</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">month</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">daLMP</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">rega</span><span class="p">,</span> <span class="n">regd</span><span class="p">,</span> <span class="n">RegCCP</span><span class="p">,</span> <span class="n">RegPCP</span></div>


<div class="viewcode-block" id="read_pjm_da_lmp"><a class="viewcode-back" href="../../../../../snl.es_gui.tools.valuation.html#snl.es_gui.tools.valuation.utilities.read_pjm_da_lmp">[docs]</a><span class="k">def</span> <span class="nf">read_pjm_da_lmp</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">node_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the day-ahead LMP file at fname and returns the NumPy ndarray corresponding to the hourly LMP at node_name.</span>
<span class="sd">    :param fname: A string containing the path to the relevant day-ahead LMP file.</span>
<span class="sd">    :param node_name: A string containing the name of the pricing node of interest.</span>
<span class="sd">    :return: LMP: A NumPy ndarray containing the hourly LMP at node-name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># read in the .csv file</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># filter rows by node_name</span>
    <span class="n">col2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">pnode_ix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">col2</span><span class="p">]</span> <span class="o">==</span> <span class="n">node_name</span><span class="p">]</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pnode_ix</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># filter Total LMP columns</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">df1</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">7</span><span class="p">:</span><span class="mi">79</span><span class="p">:</span><span class="mi">3</span><span class="p">]]</span>

    <span class="c1"># convert to NumPy ndarray, ravel, and remove NaNs</span>
    <span class="n">LMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">LMP</span> <span class="o">=</span> <span class="n">LMP</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">LMP</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">LMP</span></div>


<div class="viewcode-block" id="read_pjm_reg_signal"><a class="viewcode-back" href="../../../../../snl.es_gui.tools.valuation.html#snl.es_gui.tools.valuation.utilities.read_pjm_reg_signal">[docs]</a><span class="k">def</span> <span class="nf">read_pjm_reg_signal</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the regulation signal file at fname and returns the NumPy ndarray corresponding to the hourly integrated signal.</span>
<span class="sd">    :param fname: A string containing the path to the relevant regulation signal file.</span>
<span class="sd">    :return: RU, RD: NumPy ndarrays containing the hourly integrated regulation up/down signals.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># read in the Excel file</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">skip_footer</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># create DateTime indexing to facilitate resampling</span>
    <span class="n">dt_ix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2017-11-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">30</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;2S&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">dt_ix</span>

    <span class="c1"># define function for performing hourly integration</span>
    <span class="k">def</span> <span class="nf">_hourly_integration</span><span class="p">(</span><span class="n">array_like</span><span class="p">):</span>
        <span class="c1"># ZOH integration</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">/</span><span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">array_like</span><span class="p">)</span><span class="o">*</span><span class="n">dt</span>

    <span class="c1"># use resample to apply hourly integration</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_hourly_integration</span><span class="p">)</span>

    <span class="c1"># convert DataFrame to NumPy ndarray and ravel</span>
    <span class="n">REG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span>

    <span class="c1"># assign reg up/down values appropriately based on sign of regulation signal</span>
    <span class="n">RU</span> <span class="o">=</span> <span class="n">REG</span> <span class="o">*</span> <span class="p">(</span><span class="n">REG</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">RD</span> <span class="o">=</span> <span class="n">REG</span> <span class="o">*</span> <span class="p">(</span><span class="n">REG</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">RU</span><span class="p">,</span> <span class="n">RD</span></div>


<div class="viewcode-block" id="read_pjm_mileage"><a class="viewcode-back" href="../../../../../snl.es_gui.tools.valuation.html#snl.es_gui.tools.valuation.utilities.read_pjm_mileage">[docs]</a><span class="k">def</span> <span class="nf">read_pjm_mileage</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">month</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the historic regulation market data file at fname and returns the NumPy ndarrays for mileage data.</span>
<span class="sd">    :param fname: A string containing the path to the relevant historic regulation market data file.</span>
<span class="sd">    :param month: An int corresponding to the month of interest (1: Jan., 2: Feb., etc.)</span>
<span class="sd">    :return: Mileage_Ratio, RegA_milage, RegD_mileage: NumPy ndarrays containing computed mileage ratio and RegA/RegD hourly mileage signals.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># read in the Excel file and parse the relevant worksheet</span>
    <span class="n">wkbk</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelFile</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">wkbk</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>

    <span class="c1"># replace &quot;UNAPPROVED&quot; entries with previous filled value</span>
    <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># compute hourly mileage ratio</span>
    <span class="c1"># TODO: what do infinite mileage ratio? (REGA = 0)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;MILEAGE RATIO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;REGD_HOURLY&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;REGA_HOURLY&#39;</span><span class="p">]</span>

    <span class="n">RegA_mileage</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;REGA_HOURLY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">RegD_mileage</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;REGD_HOURLY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">Mileage_Ratio</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;MILEAGE RATIO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">return</span> <span class="n">Mileage_Ratio</span><span class="p">,</span> <span class="n">RegA_mileage</span><span class="p">,</span> <span class="n">RegD_mileage</span></div>


<div class="viewcode-block" id="read_pjm_reg_price"><a class="viewcode-back" href="../../../../../snl.es_gui.tools.valuation.html#snl.es_gui.tools.valuation.utilities.read_pjm_reg_price">[docs]</a><span class="k">def</span> <span class="nf">read_pjm_reg_price</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">month</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the historical ancillary services data file at fname and returns the NumPy ndarrays for regulation clearing prices.</span>
<span class="sd">    :param fname: A string containing the path to the relevant historical ancillary services data file.</span>
<span class="sd">    :param month: An int corresponding to the month of interest (1: Jan., 2: Feb., etc.)</span>
<span class="sd">    :return: RegCCP, RegPCP: NumPy ndarrays containing hourly regulation capacity/performance clearing price values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># read in the Excel file and parse relevant worksheet</span>
    <span class="n">wkbk</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelFile</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">wkbk</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>

    <span class="c1"># parse the relevant service</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SERVICE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;REG&#39;</span><span class="p">]</span>

    <span class="c1"># DLS hour gives NaN</span>
    <span class="n">df1</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">RegCCP</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;REG_CCP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">RegPCP</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;REG_PCP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">return</span> <span class="n">RegCCP</span><span class="p">,</span> <span class="n">RegPCP</span></div>


<div class="viewcode-block" id="read_miso_da_lmp"><a class="viewcode-back" href="../../../../../snl.es_gui.tools.valuation.html#snl.es_gui.tools.valuation.utilities.read_miso_da_lmp">[docs]</a><span class="k">def</span> <span class="nf">read_miso_da_lmp</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">node_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the day-ahead LMP file at fname and returns the NumPy ndarray corresponding to the hourly LMP at node_name.</span>
<span class="sd">    :param fname: A string containing the path to the relevant day-ahead LMP file.</span>
<span class="sd">    :param node_name: A string containing the name of the pricing node of interest.</span>
<span class="sd">    :return: LMP: A NumPy ndarray containing the hourly LMP at node-name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># parse fname for month and year values</span>
    <span class="n">month</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fname</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
    <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fname</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">nday</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">11</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="mi">31</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">year</span><span class="o">%</span><span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">nday</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">29</span>

    <span class="n">LMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nday</span><span class="p">[</span><span class="n">month</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    
        <span class="k">if</span> <span class="p">(</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="mi">2014</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span> <span class="o">==</span> <span class="mi">2015</span> <span class="ow">and</span> <span class="n">month</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">fname_</span> <span class="o">=</span> <span class="n">fname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_da_lmp.csv&quot;</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">fname_</span> <span class="o">=</span> <span class="n">fname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_da_exante_lmp.csv&quot;</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># filter rows by node_name</span>
        <span class="n">col1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">col3</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pnode_ix1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">col1</span><span class="p">]</span> <span class="o">==</span> <span class="n">node_name</span><span class="p">]</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pnode_ix1</span><span class="p">,</span> <span class="p">:]</span>
        
        <span class="c1"># find LMP values</span>
        <span class="n">pnode_ix2</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">df1</span><span class="p">[</span><span class="n">col3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;LMP&quot;</span><span class="p">]</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pnode_ix2</span><span class="p">,</span> <span class="p">:]</span>
        
        <span class="c1"># filter Total LMP columns</span>
        <span class="n">df3</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">df2</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">:</span><span class="mi">27</span><span class="p">]]</span>

        <span class="c1"># convert to NumPy ndarray, ravel, and remove NaNs</span>
        <span class="n">LMP_day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">df3</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">LMP_day</span> <span class="o">=</span> <span class="n">LMP_day</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">LMP_day</span><span class="p">)]</span> 
        <span class="n">LMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LMP</span><span class="p">,</span> <span class="n">LMP_day</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">LMP</span></div>


<div class="viewcode-block" id="read_miso_reg_price"><a class="viewcode-back" href="../../../../../snl.es_gui.tools.valuation.html#snl.es_gui.tools.valuation.utilities.read_miso_reg_price">[docs]</a><span class="k">def</span> <span class="nf">read_miso_reg_price</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the historical ancillary services data file at fname and returns the NumPy ndarrays for regulation clearing prices.</span>
<span class="sd">    :param fname: A string containing the path to the relevant historical ancillary services data file.</span>
<span class="sd">    :return: RegMCP: NumPy ndarrays containing hourly regulation capacity/mileage clearing price values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># parse fname for month and year values</span>
    <span class="n">month</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fname</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
    <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fname</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">nday</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">11</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="mi">31</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">year</span><span class="o">%</span><span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">nday</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">29</span>

    <span class="n">RegMCP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nday</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="mi">2014</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span> <span class="o">==</span> <span class="mi">2015</span> <span class="ow">and</span> <span class="n">month</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">fname_</span> <span class="o">=</span> <span class="n">fname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_asm_damcp.csv&quot;</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">fname_</span> <span class="o">=</span> <span class="n">fname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_asm_exante_damcp.csv&quot;</span>

        <span class="c1"># read in the .csv file</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="c1"># find SERREGMCP values</span>
        <span class="n">col3</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pnode_ix1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">col3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SERREGMCP&quot;</span><span class="p">]</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pnode_ix1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">df1</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">:</span><span class="mi">27</span><span class="p">]]</span>
    
        <span class="c1"># convert to NumPy ndarray, ravel, and remove NaNs</span>
        <span class="n">RegMCP_day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">RegMCP_day</span> <span class="o">=</span> <span class="n">RegMCP_day</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RegMCP_day</span><span class="p">)]</span> 
        <span class="n">RegMCP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RegMCP</span><span class="p">,</span> <span class="n">RegMCP_day</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">RegMCP</span></div>

<span class="c1">##################################################################################################################</span>
<span class="c1">#///////////////////////////////////////////////////////#</span>
<div class="viewcode-block" id="read_isone_data"><a class="viewcode-back" href="../../../../../snl.es_gui.tools.valuation.html#snl.es_gui.tools.valuation.utilities.read_isone_data">[docs]</a><span class="k">def</span> <span class="nf">read_isone_data</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">nodeid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">    Reads the historical LMP, regulation capacity, and regulation service (mileage) prices for the year &#39;year&#39;,</span>
<span class="sd">    the month &#39;month&#39; and for the node &#39;nodeid&#39;. Returns NumPy ndarrays for those three prices.</span>
<span class="sd">    :param fpath: A string containing the path to the relevant historical ancillary services data file.</span>
<span class="sd">    :param year: An int corresponding to the year of interest</span>
<span class="sd">    :param month: An int corresponding to the month of interest (1: Jan., 2: Feb., etc.)</span>
<span class="sd">    :return: daLMP, RegCCP, RegPCP: NumPy ndarrays containing hourly LMP as well as regulation capacity/performance clearing price values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">month</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nodeid</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)):</span>
        <span class="n">nodeid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nodeid</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">year</span> <span class="o">&lt;</span> <span class="mi">2018</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">year</span> <span class="o">==</span> <span class="mi">2017</span> <span class="ow">and</span> <span class="n">month</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">fnameLMP</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:d}{1:02d}</span><span class="s2">_fmlmp_</span><span class="si">{2:s}</span><span class="s2">.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">nodeid</span><span class="p">)</span>
            <span class="n">fnameRCP</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:d}{1:02d}</span><span class="s2">_fmrcp.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span> <span class="p">,</span><span class="n">month</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fnameLMP</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:d}{1:02d}</span><span class="s2">_dalmp_</span><span class="si">{2:s}</span><span class="s2">.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">nodeid</span><span class="p">)</span>
            <span class="n">fnameRCP</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:d}{1:02d}</span><span class="s2">_rcp.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span> <span class="p">,</span><span class="n">month</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fnameLMP</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:d}{1:02d}</span><span class="s2">_fmlmp_</span><span class="si">{2:s}</span><span class="s2">.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">nodeid</span><span class="p">)</span>
        <span class="n">fnameRCP</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:d}{1:02d}</span><span class="s2">_fmrcp.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span> <span class="p">,</span><span class="n">month</span><span class="p">)</span>

    <span class="n">fname_path_LMP</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;LMP&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nodeid</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="n">fnameLMP</span><span class="p">)</span>
    <span class="n">fname_path_RCP</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;RCP&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="n">fnameRCP</span><span class="p">)</span>
    <span class="n">fname_path_MILEAGE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;MileageFile.xlsx&#39;</span><span class="p">)</span>

    <span class="n">daLMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">RegCCP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">RegPCP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">miMULT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>


    <span class="k">try</span><span class="p">:</span>
        <span class="n">dfLMP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_LMP</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">daLMP</span> <span class="o">=</span> <span class="n">dfLMP</span><span class="p">[</span><span class="s1">&#39;LmpTotal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span> \
            <span class="p">(</span><span class="s1">&#39;read_isone_data: No LMP data matching input parameters found, returning empty array. (got </span><span class="si">{fname}</span><span class="s1">, </span><span class="si">{year}</span><span class="s1">, </span><span class="si">{month}</span><span class="s1">, </span><span class="si">{nodeid}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span>
                <span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fnameLMP</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">month</span><span class="p">,</span> <span class="n">nodeid</span><span class="o">=</span><span class="n">nodeid</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">year</span> <span class="o">&gt;</span> <span class="mi">2014</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">year</span> <span class="o">==</span> <span class="mi">2015</span> <span class="ow">and</span> <span class="n">month</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">dfRCP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_RCP</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">RegCCP</span> <span class="o">=</span> <span class="n">dfRCP</span><span class="p">[</span><span class="s1">&#39;RegClearingPrice&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">RegPCP</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dfRCP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_RCP</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">RegCCP</span> <span class="o">=</span> <span class="n">dfRCP</span><span class="p">[</span><span class="s1">&#39;RegCapacityClearingPrice&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">RegPCP</span> <span class="o">=</span> <span class="n">dfRCP</span><span class="p">[</span><span class="s1">&#39;RegServiceClearingPrice&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                                   
                <span class="n">dataF_mileage_file</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">fname_path_MILEAGE</span><span class="p">,</span> <span class="n">sheet_name</span> <span class="o">=</span> <span class="s1">&#39;Energy Neutral Trinary&#39;</span><span class="p">,</span> <span class="n">usecols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Fleet ATRR dispatch [MW]&#39;</span><span class="p">])</span>
                <span class="n">dataF_mileage_file</span> <span class="o">=</span> <span class="n">dataF_mileage_file</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="o">-</span><span class="mi">10</span><span class="p">]</span><span class="o">*</span><span class="mi">15</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Fleet ATRR dispatch [MW]&#39;</span><span class="p">]),</span> <span class="n">ignore_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="c1">#   changes number of data points to 24 hours; doesn&#39;t change mileage</span>
                            
                <span class="c1">#   AGC setpoints given every 4 seconds, take the total mileage for each hour; total of one day of mileage</span>
                <span class="n">hours</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataF_mileage_file</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">//</span><span class="mi">900</span><span class="p">)]</span>
                
                <span class="n">mileage_day</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">hours</span><span class="p">:</span>
                    <span class="n">dataF_mileage_hour</span> <span class="o">=</span> <span class="n">dataF_mileage_file</span><span class="p">[</span><span class="mi">900</span><span class="o">*</span><span class="n">hour</span><span class="p">:</span><span class="mi">900</span><span class="o">*</span><span class="p">(</span><span class="n">hour</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="c1">#    every 900 values represents an hour (900*4 = 3600)</span>
                    <span class="n">mileage_hour</span> <span class="o">=</span> <span class="mi">0</span> 
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataF_mileage_hour</span><span class="o">.</span><span class="n">index</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataF_mileage_hour</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">break</span>
                    
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dataF_mileage_hour</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">dataF_mileage_hour</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
                            <span class="n">mileage_hour</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dataF_mileage_hour</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dataF_mileage_hour</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">10</span>
                            
                    <span class="n">mileage_day</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mileage_hour</span><span class="p">)</span>
            
                <span class="n">dataF_mileage_day</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mileage_day</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Trinary Mileage&#39;</span><span class="p">])</span>
                
                <span class="c1">#   have one days worth of data, need one months worth</span>
                <span class="n">days</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">daLMP</span><span class="p">)</span><span class="o">//</span><span class="mi">24</span>
                <span class="n">mileage_mult</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Trinary Mileage&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">days</span><span class="p">):</span>
                    <span class="n">mileage_mult</span> <span class="o">=</span> <span class="n">mileage_mult</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataF_mileage_day</span><span class="p">,</span> <span class="n">ignore_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="c1">#   if the len are offset, make them match</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">daLMP</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">mileage_mult</span><span class="p">):</span>
                    <span class="n">diff</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">daLMP</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">mileage_mult</span><span class="p">)</span>
                    
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">diff</span><span class="p">):</span>
                        <span class="n">mileage_mult</span> <span class="o">=</span> <span class="n">mileage_mult</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataF_mileage_day</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ignore_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                        
                <span class="n">miMULT</span> <span class="o">=</span> <span class="n">mileage_mult</span><span class="p">[</span><span class="s1">&#39;Trinary Mileage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dfRCP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_RCP</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">RegCCP</span> <span class="o">=</span> <span class="n">dfRCP</span><span class="p">[</span><span class="s1">&#39;RegClearingPrice&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">RegPCP</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span> \
            <span class="p">(</span><span class="s1">&#39;read_isone_data: No ASP data matching input parameters found, returning empty array. (got </span><span class="si">{fname}</span><span class="s1">, </span><span class="si">{year}</span><span class="s1">, </span><span class="si">{month}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span>
                <span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fnameRCP</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">month</span><span class="p">))</span>
    

    <span class="k">return</span> <span class="n">daLMP</span><span class="p">,</span> <span class="n">RegCCP</span><span class="p">,</span> <span class="n">RegPCP</span><span class="p">,</span> <span class="n">miMULT</span></div>
<span class="c1">#///////////////////////////////////////////////////////#</span>


<div class="viewcode-block" id="read_miso_data"><a class="viewcode-back" href="../../../../../snl.es_gui.tools.valuation.html#snl.es_gui.tools.valuation.utilities.read_miso_data">[docs]</a><span class="k">def</span> <span class="nf">read_miso_data</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">nodeid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads the daily MISO data files and returns the NumPy ndarrays for LMP and MCP.</span>

<span class="sd">    </span>
<span class="sd">    :param fpath: root of the MISO data folder</span>
<span class="sd">    :type fpath: str</span>
<span class="sd">    :param year: year of data</span>
<span class="sd">    :type year: int or str</span>
<span class="sd">    :param month: month of data</span>
<span class="sd">    :type month: int or str</span>
<span class="sd">    :param nodeid: pricing node ID</span>
<span class="sd">    :type nodeid: str</span>
<span class="sd">    :return: arrays of data specified</span>
<span class="sd">    :rtype: NumPy ndarrays</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">RegMCP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">n_days_month</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">monthrange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_days_month</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Read daily files.</span>
        <span class="n">date_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{year}{month}{day}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">day</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2014</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2015</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">lmp_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;LMP&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;</span><span class="si">{prefix}</span><span class="s1">_da_lmp.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">date_str</span><span class="p">))</span>
            <span class="n">mcp_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;MCP&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;</span><span class="si">{prefix}</span><span class="s1">_asm_damcp.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">date_str</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">lmp_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;LMP&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;</span><span class="si">{prefix}</span><span class="s1">_da_exante_lmp.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">date_str</span><span class="p">))</span>
            <span class="n">mcp_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;MCP&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;</span><span class="si">{prefix}</span><span class="s1">_asm_exante_damcp.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">date_str</span><span class="p">))</span>
        
        <span class="c1"># LMP file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">lmp_fname</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;read_miso_data: LMP file missing, returning empty array.&#39;</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="c1"># Filter rows by node_name.</span>
        <span class="n">col1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">col3</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pnode_ix1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">col1</span><span class="p">]</span> <span class="o">==</span> <span class="n">nodeid</span><span class="p">]</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pnode_ix1</span><span class="p">,</span> <span class="p">:]</span>
        
        <span class="c1"># Find LMP values.</span>
        <span class="n">pnode_ix2</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">df1</span><span class="p">[</span><span class="n">col3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;LMP&quot;</span><span class="p">]</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pnode_ix2</span><span class="p">,</span> <span class="p">:]</span>
        
        <span class="c1"># Filter Total LMP columns.</span>
        <span class="n">df3</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">df2</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">:</span><span class="mi">27</span><span class="p">]]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">LMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;read_miso_data: A daily LMP file is missing required data, returning empty array.&#39;</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="c1"># Convert to NumPy ndarray, ravel, and remove NaNs.</span>
        <span class="n">LMP_day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">df3</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">LMP_day</span> <span class="o">=</span> <span class="n">LMP_day</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">LMP_day</span><span class="p">)]</span> 
        <span class="n">LMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LMP</span><span class="p">,</span> <span class="n">LMP_day</span><span class="p">)</span>

        <span class="c1"># MCP file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">mcp_fname</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">RegMCP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;read_miso_data: MCP file missing, returning empty array.&#39;</span><span class="p">)</span>
            <span class="k">break</span>
        
        <span class="c1"># Find SERREGMCP values.</span>
        <span class="n">col3</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pnode_ix1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">col3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SERREGMCP&quot;</span><span class="p">]</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pnode_ix1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">df1</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">:</span><span class="mi">27</span><span class="p">]]</span>
    
        <span class="c1"># convert to NumPy ndarray, ravel, and remove NaNs</span>
        <span class="n">RegMCP_day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">RegMCP_day</span> <span class="o">=</span> <span class="n">RegMCP_day</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RegMCP_day</span><span class="p">)]</span> 
        <span class="n">RegMCP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RegMCP</span><span class="p">,</span> <span class="n">RegMCP_day</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">LMP</span><span class="p">,</span> <span class="n">RegMCP</span></div>




<span class="c1">#######################################################################################################################</span>
<span class="c1"># NYISO</span>
<span class="c1">#######################################################################################################################</span>

<div class="viewcode-block" id="read_nyiso_data"><a class="viewcode-back" href="../../../../../snl.es_gui.tools.valuation.html#snl.es_gui.tools.valuation.utilities.read_nyiso_data">[docs]</a><span class="k">def</span> <span class="nf">read_nyiso_data</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">nodeid</span><span class="p">,</span> <span class="n">typedat</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">RT_DAM</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">    Reads the historical LBMP, regulation capacity, and regulation movement prices for the year &#39;year&#39;,</span>
<span class="sd">    the month &#39;month&#39; and for the node &#39;nodeid&#39;. Returns NumPy ndarrays for those three prices.</span>

<span class="sd">    :param fpath: The path to the root of the NYISO data directory</span>
<span class="sd">    :type fpath: str</span>
<span class="sd">    :param year: Year of data to read</span>
<span class="sd">    :type year: int or str</span>
<span class="sd">    :param month: Month of data to read</span>
<span class="sd">    :type month: int or str</span>
<span class="sd">    :param nodeid: ID of the node to read</span>
<span class="sd">    :type nodeid: int or str</span>
<span class="sd">    :return: daLBMP, rtLBMP, daCAP, rtCAP, rtMOV: Hourly LBMP and regulation capacity/movement clearing price values.</span>
<span class="sd">    :rtype: NumPy ndarraysx</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">############################################################</span>

    <span class="n">daLBMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">rtLBMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">daCAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">rtCAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">rtMOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">month</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nodeid</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">nodeid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nodeid</span><span class="p">)</span>

    <span class="c1">############################################################################################</span>
    <span class="c1"># folderfile = fpath</span>
    <span class="c1"># # TODO: path_nodes_file is a folder to adjust when integrating it to QuESt</span>
    <span class="c1"># path_nodes_file = &#39;C:/Users/fwilche/Documents/data_bank/NYISO/&#39;</span>
    <span class="n">path_nodes_file</span> <span class="o">=</span> <span class="s1">&#39;../../es_gui/apps/data_manager/_static/&#39;</span>
    <span class="n">pathf_nodeszones</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">path_nodes_file</span><span class="p">,</span> <span class="s1">&#39;nodes_nyiso.csv&#39;</span><span class="p">)</span>
    <span class="n">df_nodeszones</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">pathf_nodeszones</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">df_nodeszones_x</span> <span class="o">=</span> <span class="n">df_nodeszones</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_nodeszones</span><span class="p">[</span><span class="s1">&#39;Node ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">nodeid</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">if</span> <span class="n">df_nodeszones_x</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The node does NOT exists in NYISO&quot;</span><span class="p">)</span>
        <span class="c1"># raise ValueError(&#39;Not a valid bus number!!!&#39;)</span>
        <span class="k">return</span> <span class="n">daLBMP</span><span class="p">,</span> <span class="n">rtLBMP</span><span class="p">,</span> <span class="n">daCAP</span><span class="p">,</span> <span class="n">rtCAP</span><span class="p">,</span> <span class="n">rtMOV</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">df_nodeszones_x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">df_nodeszones_x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;It&#39;s a zone node&quot;</span><span class="p">)</span>
            <span class="n">zoneid</span> <span class="o">=</span> <span class="n">nodeid</span>
            <span class="n">zone_gen</span> <span class="o">=</span> <span class="s2">&quot;zone&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;It&#39;s a gen node&quot;</span><span class="p">)</span>
            <span class="n">zoneid</span> <span class="o">=</span> <span class="n">df_nodeszones_x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">zone_gen</span> <span class="o">=</span> <span class="s2">&quot;gen&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Identified zone:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">zoneid</span><span class="p">)</span>
    <span class="c1">############################################################################################</span>

    <span class="n">ndaysmonth</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">monthrange</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>
    <span class="n">ndaysmonth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ndaysmonth</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>


    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndaysmonth</span><span class="p">):</span>
        <span class="n">day_x</span> <span class="o">=</span> <span class="n">ix</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">date_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">day_x</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># print(date_str)</span>

        <span class="n">fnameLBMP_DA</span> <span class="o">=</span> <span class="n">date_str</span> <span class="o">+</span> <span class="s2">&quot;damlbmp_&quot;</span> <span class="o">+</span> <span class="n">zone_gen</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span>
        <span class="n">fnameASP_DA</span> <span class="o">=</span> <span class="n">date_str</span> <span class="o">+</span> <span class="s2">&quot;damasp.csv&quot;</span>

        <span class="n">fnameLBMP_RT</span> <span class="o">=</span> <span class="n">date_str</span> <span class="o">+</span> <span class="s2">&quot;realtime_&quot;</span> <span class="o">+</span> <span class="n">zone_gen</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span>
        <span class="n">fnameASP_RT</span> <span class="o">=</span> <span class="n">date_str</span> <span class="o">+</span> <span class="s2">&quot;rtasp.csv&quot;</span>

        <span class="n">fname_path_LBMP_DA</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;LBMP&#39;</span><span class="p">,</span> <span class="s1">&#39;DAM&#39;</span><span class="p">,</span> <span class="n">zone_gen</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">fnameLBMP_DA</span><span class="p">)</span>
        <span class="n">fname_path_ASP_DA</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;ASP&#39;</span><span class="p">,</span> <span class="s1">&#39;DAM&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">fnameASP_DA</span><span class="p">)</span>

        <span class="n">fname_path_LBMP_RT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;LBMP&#39;</span><span class="p">,</span> <span class="s1">&#39;RT&#39;</span><span class="p">,</span> <span class="n">zone_gen</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">fnameLBMP_RT</span><span class="p">)</span>
        <span class="n">fname_path_ASP_RT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;ASP&#39;</span><span class="p">,</span> <span class="s1">&#39;RT&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">fnameASP_RT</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">typedat</span> <span class="o">==</span> <span class="s2">&quot;asp&quot;</span> <span class="ow">or</span> <span class="n">typedat</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="c1"># 20170201damasp.csv</span>
            <span class="c1"># 20180501rtasp.csv</span>
            <span class="k">if</span> <span class="n">RT_DAM</span> <span class="o">==</span> <span class="s2">&quot;RT&quot;</span> <span class="ow">or</span> <span class="n">RT_DAM</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df_file</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_ASP_RT</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="n">rtCAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">rtMOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;read_nyiso_data: RT ASP file missing, returning empty array.&#39;</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">year</span><span class="o">&gt;=</span><span class="mi">2016</span> <span class="ow">and</span> <span class="n">month</span><span class="o">&gt;=</span><span class="mi">6</span> <span class="ow">and</span> <span class="n">day_x</span><span class="o">&gt;=</span><span class="mi">23</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span><span class="o">&gt;=</span><span class="mi">2016</span> <span class="ow">and</span> <span class="n">month</span><span class="o">&gt;=</span><span class="mi">7</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span><span class="o">&gt;=</span><span class="mi">2017</span><span class="p">):</span>
                    <span class="c1"># NYCA Regulation Capacity ($/MWHr) - for newest type of data</span>
                    <span class="n">df_file_rtCAP</span> <span class="o">=</span> <span class="n">df_file</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_file</span><span class="p">[</span><span class="s1">&#39;PTID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">zoneid</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;NYCA Regulation Capacity ($/MWHr)&#39;</span><span class="p">]]</span>
                    <span class="n">rtCAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rtCAP</span><span class="p">,</span> <span class="n">df_file_rtCAP</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="c1"># NYCA Regulation Movement ($/MW)</span>
                    <span class="n">df_file_rtMOV</span> <span class="o">=</span> <span class="n">df_file</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_file</span><span class="p">[</span><span class="s1">&#39;PTID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">zoneid</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;NYCA Regulation Movement ($/MW)&#39;</span><span class="p">]]</span>
                    <span class="n">rtMOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rtMOV</span><span class="p">,</span> <span class="n">df_file_rtMOV</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">year</span><span class="o">&gt;=</span><span class="mi">2001</span> <span class="ow">and</span> <span class="n">month</span><span class="o">&gt;=</span><span class="mi">10</span> <span class="ow">and</span> <span class="n">day_x</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span><span class="o">&gt;=</span><span class="mi">2001</span> <span class="ow">and</span> <span class="n">month</span><span class="o">&gt;=</span><span class="mi">11</span><span class="p">)</span> <span class="ow">or</span> \
                     <span class="p">(</span><span class="n">year</span><span class="o">&gt;=</span><span class="mi">2002</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">((</span><span class="n">year</span><span class="o">&gt;=</span><span class="mi">2016</span> <span class="ow">and</span> <span class="n">month</span><span class="o">&gt;=</span><span class="mi">6</span> <span class="ow">and</span> <span class="n">day_x</span><span class="o">&gt;=</span><span class="mi">23</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span><span class="o">&gt;=</span><span class="mi">2016</span> <span class="ow">and</span> <span class="n">month</span><span class="o">&gt;=</span><span class="mi">7</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span><span class="o">&gt;=</span><span class="mi">2017</span><span class="p">))):</span>
                    <span class="n">df_file_rtCAP</span> <span class="o">=</span> <span class="n">df_file</span><span class="p">[</span><span class="s1">&#39;East Regulation ($/MWHr)&#39;</span><span class="p">]</span>
                    <span class="n">rtCAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rtCAP</span><span class="p">,</span> <span class="n">df_file_rtCAP</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">df_file_rtMOV</span> <span class="o">=</span> <span class="n">df_file</span><span class="p">[</span><span class="s1">&#39; NYCA Regulation Movement ($/MW)&#39;</span><span class="p">]</span>
                    <span class="n">rtMOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rtMOV</span><span class="p">,</span> <span class="n">df_file_rtMOV</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="c1"># RT ancillary services for NYISO start on July 2004</span>


            <span class="k">if</span> <span class="n">RT_DAM</span> <span class="o">==</span> <span class="s2">&quot;DAM&quot;</span> <span class="ow">or</span> <span class="n">RT_DAM</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df_file</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_ASP_DA</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="n">daCAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;read_nyiso_data: DA ASP file missing, returning empty array.&#39;</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2016</span> <span class="ow">and</span> <span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">day_x</span> <span class="o">&gt;=</span> <span class="mi">23</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2016</span> <span class="ow">and</span> <span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2017</span><span class="p">):</span>
                    <span class="n">df_file_daCAP</span> <span class="o">=</span> <span class="n">df_file</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_file</span><span class="p">[</span><span class="s1">&#39;PTID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">zoneid</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;NYCA Regulation Capacity ($/MWHr)&#39;</span><span class="p">]]</span>
                    <span class="n">daCAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daCAP</span><span class="p">,</span> <span class="n">df_file_daCAP</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2001</span> <span class="ow">and</span> <span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">day_x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2001</span> <span class="ow">and</span> <span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span> <span class="ow">or</span> \
                     <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2002</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">((</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2016</span> <span class="ow">and</span> <span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">day_x</span> <span class="o">&gt;=</span> <span class="mi">23</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2016</span> <span class="ow">and</span> <span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2017</span><span class="p">))):</span>
                    <span class="n">df_file_daCAP</span> <span class="o">=</span> <span class="n">df_file</span><span class="p">[</span><span class="s1">&#39;East Regulation ($/MWHr)&#39;</span><span class="p">]</span>
                    <span class="n">daCAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daCAP</span><span class="p">,</span> <span class="n">df_file_daCAP</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df_file_daCAP</span> <span class="o">=</span> <span class="n">df_file</span><span class="p">[</span><span class="s1">&#39;Regulation ($/MWHr)&#39;</span><span class="p">]</span>
                    <span class="n">daCAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daCAP</span><span class="p">,</span> <span class="n">df_file_daCAP</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">typedat</span> <span class="o">==</span> <span class="s2">&quot;lbmp&quot;</span> <span class="ow">or</span> <span class="n">typedat</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="c1"># 20170201damlbmp_gen.csv</span>
            <span class="c1"># 20170201damlbmp_zone.csv</span>
            <span class="c1"># 20170201realtime_gen.csv</span>
            <span class="k">if</span> <span class="n">RT_DAM</span> <span class="o">==</span> <span class="s2">&quot;RT&quot;</span> <span class="ow">or</span> <span class="n">RT_DAM</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df_rtLBMP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_LBMP_RT</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="n">rtLBMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;read_nyiso_data: RT LMP file missing, returning empty array.&#39;</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="n">rtLBMP_node_x</span> <span class="o">=</span> <span class="n">df_rtLBMP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_rtLBMP</span><span class="p">[</span><span class="s1">&#39;PTID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">nodeid</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;LBMP ($/MWHr)&#39;</span><span class="p">]]</span>
                <span class="n">rtLBMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rtLBMP</span><span class="p">,</span> <span class="n">rtLBMP_node_x</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rtLBMP_node_x</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">RT_DAM</span> <span class="o">==</span> <span class="s2">&quot;DAM&quot;</span> <span class="ow">or</span> <span class="n">RT_DAM</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df_daLBMP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_LBMP_DA</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="n">daLBMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;read_nyiso_data: DA LMP file missing, returning empty array.&#39;</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="n">daLBMP_node_x</span> <span class="o">=</span> <span class="n">df_daLBMP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_daLBMP</span><span class="p">[</span><span class="s1">&#39;PTID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">nodeid</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;LBMP ($/MWHr)&#39;</span><span class="p">]]</span>
                <span class="n">daLBMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daLBMP</span><span class="p">,</span> <span class="n">daLBMP_node_x</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">daLBMP_node_x</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">daLBMP</span><span class="p">,</span> <span class="n">rtLBMP</span><span class="p">,</span> <span class="n">daCAP</span><span class="p">,</span> <span class="n">rtCAP</span><span class="p">,</span> <span class="n">rtMOV</span></div>


<span class="c1">#TODO: delete function below:</span>
<div class="viewcode-block" id="read_nyiso_data_old"><a class="viewcode-back" href="../../../../../snl.es_gui.tools.valuation.html#snl.es_gui.tools.valuation.utilities.read_nyiso_data_old">[docs]</a><span class="k">def</span> <span class="nf">read_nyiso_data_old</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">nodeid</span><span class="p">,</span> <span class="n">typedat</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">RT_DAM</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">    Reads the historical LBMP, regulation capacity, and regulation movement prices for the year &#39;year&#39;,</span>
<span class="sd">    the month &#39;month&#39; and for the node &#39;nodeid&#39;. Returns NumPy ndarrays for those three prices.</span>

<span class="sd">    :param fpath: The path to the root of the NYISO data directory</span>
<span class="sd">    :type fpath: str</span>
<span class="sd">    :param year: Year of data to read</span>
<span class="sd">    :type year: int or str</span>
<span class="sd">    :param month: Month of data to read</span>
<span class="sd">    :type month: int or str</span>
<span class="sd">    :param nodeid: ID of the node to read</span>
<span class="sd">    :type nodeid: int or str</span>
<span class="sd">    :return: daLBMP, rtLBMP, daCAP, rtCAP, rtMOV: Hourly LBMP and regulation capacity/movement clearing price values.</span>
<span class="sd">    :rtype: NumPy ndarraysx</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">############################################################</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">month</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nodeid</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">nodeid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nodeid</span><span class="p">)</span>

    <span class="c1"># folderfile = fpath</span>
    <span class="n">pathfile_aspzones</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;NYISO_aspnodes_list.csv&#39;</span><span class="p">)</span>
    <span class="n">df_aspzones</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">pathfile_aspzones</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">df_aspzones_x</span> <span class="o">=</span> <span class="n">df_aspzones</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_aspzones</span><span class="p">[</span><span class="s1">&#39;PTID&#39;</span><span class="p">]</span><span class="o">==</span> <span class="n">nodeid</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">if</span> <span class="n">df_aspzones_x</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;It&#39;s empty -must be a gen and not a zone node&quot;</span><span class="p">)</span>

        <span class="c1"># pathfile_genzones = folderfile + &#39;generator_NYISO.csv&#39;</span>
        <span class="n">pathfile_genzones</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;generator_NYISO.csv&#39;</span><span class="p">)</span>
        <span class="n">df_genzones</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">pathfile_genzones</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">df_genzones_x</span> <span class="o">=</span> <span class="n">df_genzones</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_genzones</span><span class="p">[</span><span class="s1">&#39;PTID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">nodeid</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Zone&#39;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">df_genzones_x</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">zone_gen</span> <span class="o">=</span> <span class="s2">&quot;gen&quot;</span>
            <span class="n">zone_x</span> <span class="o">=</span> <span class="n">df_genzones_x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">df_zoneid_x</span> <span class="o">=</span> <span class="n">df_aspzones</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_aspzones</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">zone_x</span><span class="p">,</span> <span class="s1">&#39;PTID&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">df_zoneid_x</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Identified zone:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">df_zoneid_x</span><span class="p">)</span>
                <span class="n">zoneid</span> <span class="o">=</span> <span class="n">df_zoneid_x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Bus outside NYISO!!!&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Not a valid bus number!!!&#39;</span><span class="p">)</span>



    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;It&#39;s a zone node&quot;</span><span class="p">)</span>
        <span class="n">zoneid</span> <span class="o">=</span> <span class="n">nodeid</span>
        <span class="n">zone_gen</span> <span class="o">=</span> <span class="s2">&quot;zone&quot;</span>

    <span class="c1">############################################################</span>

    <span class="n">ndaysmonth</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">monthrange</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>
    <span class="n">ndaysmonth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ndaysmonth</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">daLBMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">rtLBMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">daCAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">rtCAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">rtMOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndaysmonth</span><span class="p">):</span>
        <span class="n">day_x</span> <span class="o">=</span> <span class="n">ix</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">date_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">day_x</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># print(date_str)</span>

        <span class="n">fnameLBMP_DA</span> <span class="o">=</span> <span class="n">date_str</span> <span class="o">+</span> <span class="s2">&quot;damlbmp_&quot;</span> <span class="o">+</span> <span class="n">zone_gen</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span>
        <span class="n">fnameASP_DA</span> <span class="o">=</span> <span class="n">date_str</span> <span class="o">+</span> <span class="s2">&quot;damasp.csv&quot;</span>

        <span class="n">fnameLBMP_RT</span> <span class="o">=</span> <span class="n">date_str</span> <span class="o">+</span> <span class="s2">&quot;realtime_&quot;</span> <span class="o">+</span> <span class="n">zone_gen</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span>
        <span class="n">fnameASP_RT</span> <span class="o">=</span> <span class="n">date_str</span> <span class="o">+</span> <span class="s2">&quot;rtasp.csv&quot;</span>

        <span class="n">fname_path_LBMP_DA</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;LBMP&#39;</span><span class="p">,</span> <span class="s1">&#39;DAM&#39;</span><span class="p">,</span> <span class="n">zone_gen</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">fnameLBMP_DA</span><span class="p">)</span>
        <span class="n">fname_path_ASP_DA</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;ASP&#39;</span><span class="p">,</span> <span class="s1">&#39;DAM&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">fnameASP_DA</span><span class="p">)</span>

        <span class="n">fname_path_LBMP_RT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;LBMP&#39;</span><span class="p">,</span> <span class="s1">&#39;RT&#39;</span><span class="p">,</span> <span class="n">zone_gen</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">fnameLBMP_RT</span><span class="p">)</span>
        <span class="n">fname_path_ASP_RT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;ASP&#39;</span><span class="p">,</span> <span class="s1">&#39;RT&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">fnameASP_RT</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">typedat</span> <span class="o">==</span> <span class="s2">&quot;asp&quot;</span> <span class="ow">or</span> <span class="n">typedat</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="c1"># 20170201damasp.csv</span>
            <span class="c1"># 20180501rtasp.csv</span>
            <span class="k">if</span> <span class="n">RT_DAM</span> <span class="o">==</span> <span class="s2">&quot;RT&quot;</span> <span class="ow">or</span> <span class="n">RT_DAM</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df_file</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_ASP_RT</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="n">rtCAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">rtMOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;read_nyiso_data: RT ASP file missing, returning empty array.&#39;</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">year</span><span class="o">&gt;=</span><span class="mi">2016</span> <span class="ow">and</span> <span class="n">month</span><span class="o">&gt;=</span><span class="mi">6</span> <span class="ow">and</span> <span class="n">day_x</span><span class="o">&gt;=</span><span class="mi">23</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span><span class="o">&gt;=</span><span class="mi">2016</span> <span class="ow">and</span> <span class="n">month</span><span class="o">&gt;=</span><span class="mi">7</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span><span class="o">&gt;=</span><span class="mi">2017</span><span class="p">):</span>
                    <span class="c1"># NYCA Regulation Capacity ($/MWHr) - for newest type of data</span>
                    <span class="n">df_file_rtCAP</span> <span class="o">=</span> <span class="n">df_file</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_file</span><span class="p">[</span><span class="s1">&#39;PTID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">zoneid</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;NYCA Regulation Capacity ($/MWHr)&#39;</span><span class="p">]]</span>
                    <span class="n">rtCAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rtCAP</span><span class="p">,</span> <span class="n">df_file_rtCAP</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="c1"># NYCA Regulation Movement ($/MW)</span>
                    <span class="n">df_file_rtMOV</span> <span class="o">=</span> <span class="n">df_file</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_file</span><span class="p">[</span><span class="s1">&#39;PTID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">zoneid</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;NYCA Regulation Movement ($/MW)&#39;</span><span class="p">]]</span>
                    <span class="n">rtMOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rtMOV</span><span class="p">,</span> <span class="n">df_file_rtMOV</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">year</span><span class="o">&gt;=</span><span class="mi">2001</span> <span class="ow">and</span> <span class="n">month</span><span class="o">&gt;=</span><span class="mi">10</span> <span class="ow">and</span> <span class="n">day_x</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span><span class="o">&gt;=</span><span class="mi">2001</span> <span class="ow">and</span> <span class="n">month</span><span class="o">&gt;=</span><span class="mi">11</span><span class="p">)</span> <span class="ow">or</span> \
                     <span class="p">(</span><span class="n">year</span><span class="o">&gt;=</span><span class="mi">2002</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">((</span><span class="n">year</span><span class="o">&gt;=</span><span class="mi">2016</span> <span class="ow">and</span> <span class="n">month</span><span class="o">&gt;=</span><span class="mi">6</span> <span class="ow">and</span> <span class="n">day_x</span><span class="o">&gt;=</span><span class="mi">23</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span><span class="o">&gt;=</span><span class="mi">2016</span> <span class="ow">and</span> <span class="n">month</span><span class="o">&gt;=</span><span class="mi">7</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span><span class="o">&gt;=</span><span class="mi">2017</span><span class="p">))):</span>
                    <span class="n">df_file_rtCAP</span> <span class="o">=</span> <span class="n">df_file</span><span class="p">[</span><span class="s1">&#39;East Regulation ($/MWHr)&#39;</span><span class="p">]</span>
                    <span class="n">rtCAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rtCAP</span><span class="p">,</span> <span class="n">df_file_rtCAP</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">df_file_rtMOV</span> <span class="o">=</span> <span class="n">df_file</span><span class="p">[</span><span class="s1">&#39; NYCA Regulation Movement ($/MW)&#39;</span><span class="p">]</span>
                    <span class="n">rtMOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rtMOV</span><span class="p">,</span> <span class="n">df_file_rtMOV</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="c1"># RT ancillary services for NYISO start on July 2004</span>


            <span class="k">if</span> <span class="n">RT_DAM</span> <span class="o">==</span> <span class="s2">&quot;DAM&quot;</span> <span class="ow">or</span> <span class="n">RT_DAM</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df_file</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_ASP_DA</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="n">daCAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;read_nyiso_data: DA ASP file missing, returning empty array.&#39;</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2016</span> <span class="ow">and</span> <span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">day_x</span> <span class="o">&gt;=</span> <span class="mi">23</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2016</span> <span class="ow">and</span> <span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2017</span><span class="p">):</span>
                    <span class="n">df_file_daCAP</span> <span class="o">=</span> <span class="n">df_file</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_file</span><span class="p">[</span><span class="s1">&#39;PTID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">zoneid</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;NYCA Regulation Capacity ($/MWHr)&#39;</span><span class="p">]]</span>
                    <span class="n">daCAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daCAP</span><span class="p">,</span> <span class="n">df_file_daCAP</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2001</span> <span class="ow">and</span> <span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">day_x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2001</span> <span class="ow">and</span> <span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span> <span class="ow">or</span> \
                     <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2002</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">((</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2016</span> <span class="ow">and</span> <span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">day_x</span> <span class="o">&gt;=</span> <span class="mi">23</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2016</span> <span class="ow">and</span> <span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2017</span><span class="p">))):</span>
                    <span class="n">df_file_daCAP</span> <span class="o">=</span> <span class="n">df_file</span><span class="p">[</span><span class="s1">&#39;East Regulation ($/MWHr)&#39;</span><span class="p">]</span>
                    <span class="n">daCAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daCAP</span><span class="p">,</span> <span class="n">df_file_daCAP</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df_file_daCAP</span> <span class="o">=</span> <span class="n">df_file</span><span class="p">[</span><span class="s1">&#39;Regulation ($/MWHr)&#39;</span><span class="p">]</span>
                    <span class="n">daCAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daCAP</span><span class="p">,</span> <span class="n">df_file_daCAP</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">typedat</span> <span class="o">==</span> <span class="s2">&quot;lbmp&quot;</span> <span class="ow">or</span> <span class="n">typedat</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="c1"># 20170201damlbmp_gen.csv</span>
            <span class="c1"># 20170201damlbmp_zone.csv</span>
            <span class="c1"># 20170201realtime_gen.csv</span>
            <span class="k">if</span> <span class="n">RT_DAM</span> <span class="o">==</span> <span class="s2">&quot;RT&quot;</span> <span class="ow">or</span> <span class="n">RT_DAM</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df_rtLBMP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_LBMP_RT</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="n">rtLBMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;read_nyiso_data: RT LMP file missing, returning empty array.&#39;</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="n">rtLBMP_node_x</span> <span class="o">=</span> <span class="n">df_rtLBMP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_rtLBMP</span><span class="p">[</span><span class="s1">&#39;PTID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">nodeid</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;LBMP ($/MWHr)&#39;</span><span class="p">]]</span>
                <span class="n">rtLBMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rtLBMP</span><span class="p">,</span> <span class="n">rtLBMP_node_x</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>


            <span class="k">if</span> <span class="n">RT_DAM</span> <span class="o">==</span> <span class="s2">&quot;DAM&quot;</span> <span class="ow">or</span> <span class="n">RT_DAM</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df_daLBMP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_LBMP_DA</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="n">daLBMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;read_nyiso_data: DA LMP file missing, returning empty array.&#39;</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="n">daLBMP_node_x</span> <span class="o">=</span> <span class="n">df_daLBMP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_daLBMP</span><span class="p">[</span><span class="s1">&#39;PTID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">nodeid</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;LBMP ($/MWHr)&#39;</span><span class="p">]]</span>
                <span class="n">daLBMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daLBMP</span><span class="p">,</span> <span class="n">daLBMP_node_x</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">daLBMP</span><span class="p">,</span> <span class="n">rtLBMP</span><span class="p">,</span> <span class="n">daCAP</span><span class="p">,</span> <span class="n">rtCAP</span><span class="p">,</span> <span class="n">rtMOV</span></div>

<span class="c1">#######################################################################################################################</span>

<span class="c1">#######################################################################################################################</span>
<span class="c1"># SPP</span>
<span class="c1">#######################################################################################################################</span>

<div class="viewcode-block" id="read_spp_data"><a class="viewcode-back" href="../../../../../snl.es_gui.tools.valuation.html#snl.es_gui.tools.valuation.utilities.read_spp_data">[docs]</a><span class="k">def</span> <span class="nf">read_spp_data</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">typedat</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">    Reads the historical LMP, regulation capacity, and regulation service (mileage) prices for the year &#39;year&#39;,</span>
<span class="sd">    the month &#39;month&#39; and for the node &#39;nodeid&#39;. Returns NumPy ndarrays for those three prices.</span>
<span class="sd">    :param fpath: A string containing the path to the relevant historical ancillary services data file.</span>
<span class="sd">    :param year: An int corresponding to the year of interest</span>
<span class="sd">    :param month: An int corresponding to the month of interest (1: Jan., 2: Feb., etc.)</span>
<span class="sd">    :param node: A string with the name of the node in SPP</span>
<span class="sd">    :param typedat: xxxxxx xxxxxxx</span>
<span class="sd">    :param RT_DAM: xxxxxxxxx xxxx</span>
<span class="sd">    :return: daLMP, daMCPRU, daMCPRD: NumPy ndarrays containing hourly LMP as well as regulation up and down prices for the SPP market</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">daLMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">daMCPRU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">daMCPRD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">month</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>

    <span class="c1">############################################################################################</span>
    <span class="c1"># TODO: path_nodes_file is a folder to adjust when integrating it to QuESt</span>
    <span class="n">path_nodes_file</span> <span class="o">=</span> <span class="s1">&#39;../../es_gui/apps/data_manager/_static/&#39;</span>
    <span class="n">pathf_nodeszones</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">path_nodes_file</span><span class="p">,</span> <span class="s1">&#39;nodes_spp.csv&#39;</span><span class="p">)</span>
    <span class="n">df_nodes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">pathf_nodeszones</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;cp1252&quot;</span><span class="p">)</span>
    <span class="n">df_nodes_x</span> <span class="o">=</span> <span class="n">df_nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_nodes</span><span class="p">[</span><span class="s1">&#39;Node ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">if</span> <span class="n">df_nodes_x</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The node does NOT exists in SPP&quot;</span><span class="p">)</span>
        <span class="c1"># raise ValueError(&#39;Not a valid bus number!!!&#39;)</span>
        <span class="k">return</span> <span class="n">daLMP</span><span class="p">,</span> <span class="n">daMCPRU</span><span class="p">,</span> <span class="n">daMCPRD</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nodetype</span> <span class="o">=</span> <span class="n">df_nodes_x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nodetype</span> <span class="o">==</span> <span class="s1">&#39;Location&#39;</span><span class="p">:</span>
            <span class="c1"># print(&#39;It is a Location node&#39;)</span>
            <span class="n">bus_loc</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="s2">&quot;SL&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">nodetype</span> <span class="o">==</span> <span class="s1">&#39;Bus&#39;</span><span class="p">:</span>
            <span class="c1"># print(&#39;It is a Bus node&#39;)</span>
            <span class="n">bus_loc</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bus&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">]</span>

    <span class="c1"># TODO: figure out the reserve zone for each node, for SPP there are 5 reserve zones and there should be a correspondance with the nodes</span>
    <span class="n">ResZone</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1">############################################################################################</span>

    <span class="c1"># Read only the DA market</span>

    <span class="n">ndaysmonth</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">monthrange</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>
    <span class="n">ndaysmonth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ndaysmonth</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndaysmonth</span><span class="p">):</span>
        <span class="n">day_x</span> <span class="o">=</span> <span class="n">ix</span><span class="o">+</span><span class="mi">1</span>

        <span class="n">fnameLMP_DA</span> <span class="o">=</span> <span class="s2">&quot;DA-LMP-</span><span class="si">{0:s}</span><span class="s2">-</span><span class="si">{1:d}{2:02d}{3:02d}</span><span class="s2">0100.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bus_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day_x</span><span class="p">)</span>
        <span class="n">fnameMCP_DA</span> <span class="o">=</span> <span class="s2">&quot;DA-MCP-</span><span class="si">{0:d}{1:02d}{2:02d}</span><span class="s2">0100.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day_x</span><span class="p">)</span>

        <span class="n">fname_path_LMP_DA</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;LMP&#39;</span><span class="p">,</span> <span class="s1">&#39;DAM&#39;</span><span class="p">,</span> <span class="n">bus_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">fnameLMP_DA</span><span class="p">)</span>
        <span class="n">fname_path_MCP_DA</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;MCP&#39;</span><span class="p">,</span> <span class="s1">&#39;DAM&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">fnameMCP_DA</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">typedat</span> <span class="o">==</span> <span class="s2">&quot;lmp&quot;</span> <span class="ow">or</span> <span class="n">typedat</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="c1"># DA-LMP-B-201707010100.csv</span>
            <span class="c1"># DA-LMP-SL-201707010100.csv</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">df_daLMP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_LMP_DA</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">daLMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;read_spp_data: LMP file missing, returning empty array.&#39;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="n">daLMP_node_x</span> <span class="o">=</span> <span class="n">df_daLMP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_daLMP</span><span class="p">[</span><span class="s1">&#39;Pnode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;LMP&#39;</span><span class="p">]]</span>
            <span class="n">daLMP_node_x</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">daLMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daLMP</span><span class="p">,</span> <span class="n">daLMP_node_x</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">daLMP_node_x</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">typedat</span> <span class="o">==</span> <span class="s2">&quot;mcp&quot;</span> <span class="ow">or</span> <span class="n">typedat</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="c1"># DA-MCP-201707010100.csv</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">df_daMCP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_MCP_DA</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">daMCPRU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">daMCPRD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;read_spp_data: MCP file missing, returning empty arrays.&#39;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="c1"># print(&#39;Warning -reserve zone not figured out!!!&#39;)</span>
            <span class="n">daMCPRU_node_x</span> <span class="o">=</span> <span class="n">df_daMCP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_daMCP</span><span class="p">[</span><span class="s1">&#39;Reserve Zone&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">ResZone</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;RegUP&#39;</span><span class="p">]]</span>
            <span class="n">daMCPRD_node_x</span> <span class="o">=</span> <span class="n">df_daMCP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_daMCP</span><span class="p">[</span><span class="s1">&#39;Reserve Zone&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">ResZone</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;RegDN&#39;</span><span class="p">]]</span>

            <span class="n">daMCPRU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daMCPRU</span><span class="p">,</span> <span class="n">daMCPRU_node_x</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">daMCPRD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daMCPRD</span><span class="p">,</span> <span class="n">daMCPRD_node_x</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">daLMP</span><span class="p">,</span> <span class="n">daMCPRU</span><span class="p">,</span> <span class="n">daMCPRD</span></div>


<div class="viewcode-block" id="read_spp_data_old"><a class="viewcode-back" href="../../../../../snl.es_gui.tools.valuation.html#snl.es_gui.tools.valuation.utilities.read_spp_data_old">[docs]</a><span class="k">def</span> <span class="nf">read_spp_data_old</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">typedat</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">    Reads the historical LMP, regulation capacity, and regulation service (mileage) prices for the year &#39;year&#39;,</span>
<span class="sd">    the month &#39;month&#39; and for the node &#39;nodeid&#39;. Returns NumPy ndarrays for those three prices.</span>
<span class="sd">    :param fpath: A string containing the path to the relevant historical ancillary services data file.</span>
<span class="sd">    :param year: An int corresponding to the year of interest</span>
<span class="sd">    :param month: An int corresponding to the month of interest (1: Jan., 2: Feb., etc.)</span>
<span class="sd">    :param node: A string with the name of the node in SPP</span>
<span class="sd">    :param typedat: xxxxxx xxxxxxx</span>
<span class="sd">    :param RT_DAM: xxxxxxxxx xxxx</span>
<span class="sd">    :return: daLMP, daMCPRU, daMCPRD: NumPy ndarrays containing hourly LMP as well as regulation up and down prices for the SPP market</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">############################################################</span>
    <span class="n">path_nodes_file</span> <span class="o">=</span> <span class="s1">&#39;../../es_gui/apps/data_manager/_static/&#39;</span>
    <span class="n">pathf_nodeszones</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">path_nodes_file</span><span class="p">,</span> <span class="s1">&#39;nodes_spp.csv&#39;</span><span class="p">)</span>

    <span class="c1">############################################################</span>
    <span class="c1">############################################################</span>

    <span class="n">pathfile_locations</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;SPP_locations_list.csv&#39;</span><span class="p">)</span>
    <span class="n">df_locations</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">pathfile_locations</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">df_locations_x</span> <span class="o">=</span> <span class="n">df_locations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_locations</span><span class="p">[</span><span class="s1">&#39;Pnode&#39;</span><span class="p">]</span><span class="o">==</span> <span class="n">node</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">df_locations_x</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;It is a Location node&#39;</span><span class="p">)</span>
        <span class="n">bus_loc</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="s2">&quot;SL&quot;</span><span class="p">]</span>
        <span class="n">pnode_x</span> <span class="o">=</span> <span class="n">df_locations_x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># pathfile_buses = folderfile + &#39;SPP_buses_list.csv&#39;</span>
        <span class="n">pathfile_buses</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;SPP_buses_list.csv&#39;</span><span class="p">)</span>
        <span class="n">df_buses</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">pathfile_buses</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">df_buses_x</span> <span class="o">=</span> <span class="n">df_buses</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_buses</span><span class="p">[</span><span class="s1">&#39;Pnode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df_buses_x</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;It is a Bus node&#39;</span><span class="p">)</span>
            <span class="n">bus_loc</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bus&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">]</span>
            <span class="n">pnode_x</span> <span class="o">=</span> <span class="n">df_buses_x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown Node!!!&#39;</span><span class="p">)</span>

    <span class="c1"># TODO: figure out the reserve zone for each node, for SPP there are 5 reserve zones and there should be a correspondance with the nodes</span>
    <span class="c1"># Reserve Zone:</span>
    <span class="n">ResZone</span> <span class="o">=</span> <span class="mi">1</span>


    <span class="c1"># Read only the DA market</span>

    <span class="n">ndaysmonth</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">monthrange</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>
    <span class="n">ndaysmonth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ndaysmonth</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">daLMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">daMCPRU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">daMCPRD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndaysmonth</span><span class="p">):</span>
        <span class="n">day_x</span> <span class="o">=</span> <span class="n">ix</span><span class="o">+</span><span class="mi">1</span>

        <span class="n">fnameLMP_DA</span> <span class="o">=</span> <span class="s2">&quot;DA-LMP-</span><span class="si">{0:s}</span><span class="s2">-</span><span class="si">{1:d}{2:02d}{3:02d}</span><span class="s2">0100.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bus_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day_x</span><span class="p">)</span>
        <span class="n">fnameMCP_DA</span> <span class="o">=</span> <span class="s2">&quot;DA-MCP-</span><span class="si">{0:d}{1:02d}{2:02d}</span><span class="s2">0100.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day_x</span><span class="p">)</span>

        <span class="n">fname_path_LMP_DA</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;LMP&#39;</span><span class="p">,</span> <span class="s1">&#39;DAM&#39;</span><span class="p">,</span> <span class="n">bus_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">fnameLMP_DA</span><span class="p">)</span>
        <span class="n">fname_path_MCP_DA</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;MCP&#39;</span><span class="p">,</span> <span class="s1">&#39;DAM&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">fnameMCP_DA</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">typedat</span> <span class="o">==</span> <span class="s2">&quot;lmp&quot;</span> <span class="ow">or</span> <span class="n">typedat</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="c1"># DA-LMP-B-201707010100.csv</span>
            <span class="c1"># DA-LMP-SL-201707010100.csv</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">df_daLMP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_LMP_DA</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">daLMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;read_spp_data: LMP file missing, returning empty array.&#39;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="n">daLMP_node_x</span> <span class="o">=</span> <span class="n">df_daLMP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_daLMP</span><span class="p">[</span><span class="s1">&#39;Pnode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;LMP&#39;</span><span class="p">]]</span>
            <span class="n">daLMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daLMP</span><span class="p">,</span> <span class="n">daLMP_node_x</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">typedat</span> <span class="o">==</span> <span class="s2">&quot;mcp&quot;</span> <span class="ow">or</span> <span class="n">typedat</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="c1"># DA-MCP-201707010100.csv</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">df_daMCP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_MCP_DA</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">daMCPRU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">daMCPRD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;read_spp_data: MCP file missing, returning empty arrays.&#39;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning -reserve zone not figured out!!!&#39;</span><span class="p">)</span>
            <span class="n">daMCPRU_node_x</span> <span class="o">=</span> <span class="n">df_daMCP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_daMCP</span><span class="p">[</span><span class="s1">&#39;Reserve Zone&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ResZone</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;RegUP&#39;</span><span class="p">]]</span>
            <span class="n">daMCPRD_node_x</span> <span class="o">=</span> <span class="n">df_daMCP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_daMCP</span><span class="p">[</span><span class="s1">&#39;Reserve Zone&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ResZone</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;RegDN&#39;</span><span class="p">]]</span>

            <span class="n">daMCPRU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daMCPRU</span><span class="p">,</span> <span class="n">daMCPRU_node_x</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">daMCPRD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daMCPRD</span><span class="p">,</span> <span class="n">daMCPRD_node_x</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">daLMP</span><span class="p">,</span> <span class="n">daMCPRU</span><span class="p">,</span> <span class="n">daMCPRD</span></div>
<span class="c1">#######################################################################################################################</span>

<span class="c1">#######################################################################################################################</span>
<span class="c1"># CAISO</span>
<span class="c1">#######################################################################################################################</span>

<div class="viewcode-block" id="read_caiso_data"><a class="viewcode-back" href="../../../../../snl.es_gui.tools.valuation.html#snl.es_gui.tools.valuation.utilities.read_caiso_data">[docs]</a><span class="k">def</span> <span class="nf">read_caiso_data</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">nodeid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">    Reads the historical LMP, regulation up/down and regulation mileage up/down for the year &#39;year&#39;,</span>
<span class="sd">    the month &#39;month&#39; and for the node &#39;nodeid&#39;. Returns NumPy ndarrays for those three prices.</span>

<span class="sd">    :param fpath: The path to the root of the PJM data directory</span>
<span class="sd">    :type fpath: str</span>
<span class="sd">    :param year: Year of data to read</span>
<span class="sd">    :type year: int or str</span>
<span class="sd">    :param month: Month of data to read</span>
<span class="sd">    :type month: int or str</span>
<span class="sd">    :param nodeid: ID of the node to read</span>
<span class="sd">    :type nodeid: str</span>
<span class="sd">    :return: daLMP, RegCCP, RegPCP: Hourly LMP and regulation capacity/performance clearing price values.</span>
<span class="sd">    :rtype: NumPy ndarrays</span>
<span class="sd">    &quot;&quot;&quot;</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">    For CAISO certain prices have:</span>
<span class="sd">    _CAISO</span>
<span class="sd">    _CAISO_EXP</span>
<span class="sd">    _NP26</span>
<span class="sd">    _NP26_EXP</span>
<span class="sd">    _SP26</span>
<span class="sd">    _SP26_EXP</span>

<span class="sd">    we only use the _CAISO_EXP ones (for mileage prices they are the only ones)</span>

<span class="sd">    AS_CAISO_EXP_RD_CLR_PRC</span>
<span class="sd">    AS_CAISO_EXP_RU_CLR_PRC</span>

<span class="sd">    AS_CAISO_EXP_RMD_CLR_PRC</span>
<span class="sd">    AS_CAISO_EXP_RMU_CLR_PRC</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">daLMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">daREGU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">daREGD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">daRMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">daRMD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">RMU_MM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">RMD_MM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">RMU_PACC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">RMD_PACC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">month</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>

    <span class="c1"># Names examples:</span>
    <span class="c1"># 201601_dalmp_LAKESID2_7_UNITS-APND.csv</span>
    <span class="c1"># 201601_asp.csv</span>
    <span class="c1"># 201601_regm.csv</span>
    <span class="n">fnameLMP</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:d}{1:02d}</span><span class="s2">_dalmp_</span><span class="si">{2:s}</span><span class="s2">.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">nodeid</span><span class="p">)</span>
    <span class="n">fnameASP</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:d}{1:02d}</span><span class="s2">_asp.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>
    <span class="n">fnameMILEAGE</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:d}{1:02d}</span><span class="s2">_regm.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>

    <span class="n">fname_path_LMP</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;LMP&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nodeid</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="n">fnameLMP</span><span class="p">)</span>
    <span class="n">fname_path_ASP</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;ASP&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="n">fnameASP</span><span class="p">)</span>
    <span class="n">fname_path_MILEAGE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;MILEAGE&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="n">fnameMILEAGE</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">dfLMP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_LMP</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">daLMP</span> <span class="o">=</span> <span class="n">dfLMP</span><span class="p">[</span><span class="s1">&#39;LMP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span> \
            <span class="p">(</span>
                <span class="s1">&#39;read_caiso_data: No LMP data matching input parameters found, returning empty array. (got </span><span class="si">{fname}</span><span class="s1">, </span><span class="si">{year}</span><span class="s1">, </span><span class="si">{month}</span><span class="s1">, </span><span class="si">{nodeid}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span>
                <span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fnameLMP</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">month</span><span class="p">,</span> <span class="n">nodeid</span><span class="o">=</span><span class="n">nodeid</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">dfASP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_ASP</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">daREGU</span> <span class="o">=</span> <span class="n">dfASP</span><span class="p">[</span><span class="s1">&#39;AS_CAISO_EXP_RU_CLR_PRC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">daREGD</span> <span class="o">=</span> <span class="n">dfASP</span><span class="p">[</span><span class="s1">&#39;AS_CAISO_EXP_RD_CLR_PRC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">daRMU</span> <span class="o">=</span> <span class="n">dfASP</span><span class="p">[</span><span class="s1">&#39;AS_CAISO_EXP_RMU_CLR_PRC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">daRMD</span> <span class="o">=</span> <span class="n">dfASP</span><span class="p">[</span><span class="s1">&#39;AS_CAISO_EXP_RMD_CLR_PRC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span> \
            <span class="p">(</span>
                <span class="s1">&#39;read_caiso_data: No ASP data matching input parameters found, returning empty array. (got </span><span class="si">{fname}</span><span class="s1">, </span><span class="si">{year}</span><span class="s1">, </span><span class="si">{month}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span>
                <span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fnameASP</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">month</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">dfMIL_ACC</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_path_MILEAGE</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">RMU_MM</span> <span class="o">=</span> <span class="n">dfMIL_ACC</span><span class="p">[</span><span class="s1">&#39;RMU_SYS_MIL_MUL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">RMD_MM</span> <span class="o">=</span> <span class="n">dfMIL_ACC</span><span class="p">[</span><span class="s1">&#39;RMD_SYS_MIL_MUL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">RMU_PACC</span> <span class="o">=</span> <span class="n">dfMIL_ACC</span><span class="p">[</span><span class="s1">&#39;RMU_SYS_PERF_ACC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">RMD_PACC</span> <span class="o">=</span> <span class="n">dfMIL_ACC</span><span class="p">[</span><span class="s1">&#39;RMD_SYS_PERF_ACC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span> \
            <span class="p">(</span>
                <span class="s1">&#39;read_caiso_data: No MILEAGE and PERFORMANCE ACCURACY data matching input parameters found, returning empty array. (got </span><span class="si">{fname}</span><span class="s1">, </span><span class="si">{year}</span><span class="s1">, </span><span class="si">{month}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span>
                <span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fnameMILEAGE</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">month</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">daLMP</span><span class="p">,</span> <span class="n">daREGU</span><span class="p">,</span> <span class="n">daREGD</span><span class="p">,</span> <span class="n">daRMU</span><span class="p">,</span> <span class="n">daRMD</span><span class="p">,</span> <span class="n">RMU_MM</span><span class="p">,</span> <span class="n">RMD_MM</span><span class="p">,</span> <span class="n">RMU_PACC</span><span class="p">,</span> <span class="n">RMD_PACC</span></div>
    <span class="c1"># TODO: understand the units of the MILEAGE MULTIPLIERS</span>

<span class="c1">#######################################################################################################################</span>

<span class="c1">#######################################################################################################################</span>
<span class="c1">#######################################################################################################################</span>









<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">es_gui.tools.valuation.valuation_optimizer</span> <span class="kn">import</span> <span class="n">ValuationOptimizer</span>

    <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;PJM&#39;</span><span class="p">)</span>
    <span class="n">year</span> <span class="o">=</span> <span class="mi">2015</span>
    <span class="n">month</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">nodeid</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>

    <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">12</span><span class="p">]:</span>
        <span class="n">daLMP</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">rega</span><span class="p">,</span> <span class="n">regd</span><span class="p">,</span> <span class="n">RegCCP</span><span class="p">,</span> <span class="n">RegPCP</span> <span class="o">=</span> <span class="n">read_pjm_data</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">,</span><span class="n">nodeid</span><span class="p">)</span>

        <span class="n">op</span> <span class="o">=</span> <span class="n">ValuationOptimizer</span><span class="p">(</span><span class="n">market_type</span><span class="o">=</span><span class="s1">&#39;pjm_pfp&#39;</span><span class="p">)</span>

        <span class="n">op</span><span class="o">.</span><span class="n">price_electricity</span> <span class="o">=</span> <span class="n">daLMP</span>
        <span class="n">op</span><span class="o">.</span><span class="n">mileage_ratio</span> <span class="o">=</span> <span class="n">mr</span>
        <span class="n">op</span><span class="o">.</span><span class="n">mileage_slow</span> <span class="o">=</span> <span class="n">rega</span>
        <span class="n">op</span><span class="o">.</span><span class="n">mileage_fast</span> <span class="o">=</span> <span class="n">regd</span>
        <span class="n">op</span><span class="o">.</span><span class="n">price_reg_capacity</span> <span class="o">=</span> <span class="n">RegCCP</span>
        <span class="n">op</span><span class="o">.</span><span class="n">price_reg_performance</span> <span class="o">=</span> <span class="n">RegPCP</span>

        <span class="n">handler_requests</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">handler_requests</span><span class="p">[</span><span class="s1">&#39;iso&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;PJM&#39;</span>
        <span class="n">handler_requests</span><span class="p">[</span><span class="s1">&#39;market type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pjm_pfp&#39;</span>
        <span class="n">handler_requests</span><span class="p">[</span><span class="s1">&#39;months&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">month</span><span class="p">,</span> <span class="n">year</span><span class="p">),]</span>
        <span class="n">handler_requests</span><span class="p">[</span><span class="s1">&#39;node id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodeid</span>

        <span class="n">results</span><span class="p">,</span> <span class="n">gross_revenue</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">gross_revenue</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Quest Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>