#: import calendar calendar
#: import webbrowser webbrowser
#: import datetime datetime
#: import app kivy.app

<RateStructureDataScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: 10
        spacing: 20
        
        BoxLayout:
            orientation:

            RateStructureScreenManager:

<RateStructureUtilitySearchScreen>:
    api_key_input: api_key_input
    search_text_input: search_text_input
    search_button: search_button
    # chkbx_by_name: chkbx_by_name
    # chkbx_by_zip: chkbx_by_zip
    # chkbx_by_state: chkbx_by_state
    by_name_toggle: by_name_toggle
    by_zip_toggle: by_zip_toggle
    by_state_toggle: by_state_toggle
    utility_select_bx: utility_select_bx
    utility_rv: utility_rv
    rate_structure_select_bx: rate_structure_select_bx
    rate_structure_rv: rate_structure_rv
    utility_rv_text_filter: utility_rv_text_filter
    rate_structure_rv_text_filter: rate_structure_rv_text_filter
    rate_structure_desc: rate_structure_desc
    
    BoxLayout:
        orientation: 'vertical'
        padding: 10
        spacing: 5

        DataManagerTitle:
            size_hint_y: 0.05
            text: 'Search for a utility rate structure.'
        
        BoxLayout:
            orientation: 'vertical'
            spacing: 10
            padding: (425, 0)
            size_hint_y: 0.2

            BoxLayout:
                orientation: 'horizontal'
                spacing: 10
                size_hint_y: 0.33

                DataManagerBodyText:
                    text: 'OpenEI API key [font=Modern Pictograms][color=00ADD0][ref=openEIkeyHelp]?[/ref][/color][/font]'
                    markup: True
                    on_ref_press: root.open_openei_key_help()
                    size_hint_x: 0.3

                TextInput:
                    id: api_key_input
                    multiline: False
                    #password: True
                    write_tab: False
                    hint_text: 'API key'
                    text: app.App.get_running_app().config.get('data_manager_openei', 'openei_key')
                    size_hint_x: 0.7
            
            BoxLayout:
                orientation: 'horizontal'
                spacing: 10
                size_hint_y: 0.33

                TextInput:
                    id: search_text_input
                    multiline: False
                    size_hint_x: 0.8
                    write_tab: False
                    hint_text: 'Search by name, zip code, or state'
                
                TileButton:
                    id: search_button
                    background_color: C(hex_primary)
                    size_hint_x: 0.2
                    text: 'Search'
                    on_release: root.execute_search()
            
            GridLayout:
                size_hint_y: 0.33
                cols: 3
                spacing: 10
                padding: (75, 0)
                # row_force_default: True
                # row_default_height: self.height/8

                ToggleTileButton:
                    id: by_name_toggle
                    group: 'search_type'
                    text: 'by name'
                    state: 'down'
                
                ToggleTileButton:
                    id: by_zip_toggle
                    group: 'search_type'
                    text: 'by zip'
                
                ToggleTileButton:
                    id: by_state_toggle
                    group: 'search_type'
                    text: 'by state (abbr.)'

                # BoxLayout:
                #     orientation: 'horizontal'
                #     spacing: 10

                #     DataManagerCheckbox:
                #         id: chkbx_by_name
                #         group: 'search_type'

                #     DataManagerBodyText:
                #         text: 'by name'
                #         size_hint_x: 0.95
                
                # BoxLayout:
                #     orientation: 'horizontal'
                #     spacing: 10

                #     DataManagerCheckbox:
                #         id: chkbx_by_zip
                #         group: 'search_type'

                #     DataManagerBodyText:
                #         text: 'by zip'
                #         size_hint_x: 0.95
                
                # BoxLayout:
                #     orientation: 'horizontal'
                #     spacing: 10

                #     DataManagerCheckbox:
                #         id: chkbx_by_state
                #         group: 'search_type'

                #     DataManagerBodyText:
                #         text: 'by state (abbr.)'
                #         size_hint_x: 0.95
                
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: 0.7
            spacing: 20
            padding: (50, 0)

            BoxLayout:
                id: utility_select_bx
                orientation: 'vertical'
                size_hint_x: 0.3
                spacing: 10
                opacity: 0.05

                DataManagerContentTitle:
                    text: 'Select a utility.'
                    color: C(hex_pms178)
                    size_hint_y: 0.1
                    font_size: large_font

                TextInput:
                    id: utility_rv_text_filter
                    size_hint_y: 0.1
                    on_text: utility_rv.filter_rv_data(self.text)
                    hint_text: 'Filter by name'
                    multiline: False

                MyRecycleView:
                    id: utility_rv
                    viewclass: 'UtilitySearchRVEntry'
                    size_hint_y: 0.8

                    SelectableRecycleBoxLayout:
                        multiselect: False
                        touch_multiselect: False
            
            BoxLayout:
                id: rate_structure_select_bx
                orientation: 'vertical'
                spacing: 10
                opacity: 0.05
                size_hint_x: 0.7

                DataManagerContentTitle:
                    text: 'Select a rate structure.'
                    color: C(hex_pms178)
                    size_hint_y: 0.1
                    font_size: large_font

                TextInput:
                    id: rate_structure_rv_text_filter
                    size_hint_y: 0.1
                    on_text: rate_structure_rv.filter_rv_data(self.text)
                    hint_text: 'Filter by name'
                    multiline: False

                MyRecycleView:
                    id: rate_structure_rv
                    viewclass: 'RateStructureRVEntry'
                    size_hint_y: 0.4

                    SelectableRecycleBoxLayout:
                        multiselect: False
                        touch_multiselect: False
            
                ScrollView:
                    size_hint_x: 1
                    size_hint_y: 0.4
                    scroll_type: ['bars', 'content']
                    effect_cls: 'OpacityScrollEffect'

                    DataManagerBodyText:
                        id: rate_structure_desc
                        # text_size: self.size
                        text: ''
                        size_hint_y: None
                        size_hint_x: 1
                        markup: True
                        valign: 'top'
                        halign: 'justify'
                        font_size: stnd_font
                        font_name: 'Open Sans'
                
        AnchorLayout:
            anchor_y: 'center'
            anchor_x: 'center'
            size_hint_y: 0.05

            BoxLayout:
                orientation: 'horizontal'
                size_hint_x: 0.35
                spacing: 10

                BoxLayout:
                    size_hint_x: 0.5

                TileButton:
                    size_hint_x: 0.5
                    background_color: C(hex_primary)
                    text: 'Continue'
                    on_release:
                        root.manager.transition.duration = BASE_TRANSITION_DUR
                        root.manager.transition.direction = 'left'
                        root.next_screen()

<RateStructureEnergyRateStructureScreen>:
    rate_structure_period_table: rate_structure_period_table
    weekday_chart: weekday_chart
    weekend_chart: weekend_chart

    BoxLayout:
        orientation: 'vertical'
        padding: 10
        spacing: 5

        DataManagerTitle:
            size_hint_y: 0.05
            text: 'Verify the energy rate structure.'
        
        BoxLayout:
            orientation: 'horizontal'
            spacing: 10
            padding: (50, 0)
            size_hint_y: 0.90

            RateStructurePeriodTable:
                id: rate_structure_period_table
                cols: 1
                spacing: 2
                size_hint_x: 0.3
                padding: (25, 5)
                row_force_default: True
                row_default_height: 28
                
                GridLayout:
                    cols: 2
                    spacing: 5

                    DataManagerContentSubtitle:
                        size_hint_x: 0.3
                        # font_size: stnd_font
                        text: 'Period'
                    
                    DataManagerContentSubtitle:
                        size_hint_x: 0.7
                        # font_size: stnd_font
                        text: 'Rate [$/kWh]'
            
            BoxLayout:
                orientation: 'vertical'
                size_hint_x: 0.1

                DataManagerContentTitle:
                    text: 'Weekday'
                    font_size: stnd_font
                
                DataManagerContentTitle:
                    text: 'Weekend'
                    font_size: stnd_font

            BoxLayout:
                orientation: 'vertical'
                # spacing: 5
                size_hint_x: 0.6

                BoxLayout:
                    orientation: 'vertical'
                    # spacing: 5
                    
                    RateStructureScheduleGrid:
                        id: weekday_chart
            
                    # RateScheduleChart:
                    #     size_hint_y: 0.9
                    #     id: weekday_chart
                        
                
                BoxLayout:
                    orientation: 'vertical'
                    # spacing: 5
                    
                    RateStructureScheduleGrid:
                        id: weekend_chart
            
                    # RateScheduleChart:
                    #     size_hint_y: 0.9
                    #     id: weekend_chart
                        
        
        AnchorLayout:
            anchor_y: 'center'
            anchor_x: 'center'
            size_hint_y: 0.05

            BoxLayout:
                orientation: 'horizontal'
                size_hint_x: 0.35
                spacing: 10

                TileButton:
                    size_hint_x: 0.5
                    background_color: C(hex_primary)
                    text: 'Previous'
                    on_release:
                        root.manager.transition.duration = BASE_TRANSITION_DUR/2
                        root.manager.transition.direction = 'right'
                        root.manager.current = root.manager.previous()

                TileButton:
                    size_hint_x: 0.5
                    background_color: C(hex_primary)
                    text: 'Continue'
                    on_release:
                        root.manager.transition.duration = BASE_TRANSITION_DUR
                        root.manager.transition.direction = 'left'
                        root.next_screen()

<RateStructureTableRow>:
    cols: 3
    spacing: 5

    name: name
    text_input: text_input
    copy_down_button: copy_down_button

    DataManagerBodyText:
        id: name
        size_hint_x: 0.3
        text: ''
        color: C(hex_black)
        font_size: sp(16)

    RateStructureRateTextInput:
        id: text_input
        size_hint_x: 0.6
        on_focus: root._validate_input()
    
    BoxLayout:
        orientation: 'horizontal'
        spacing: 5
        size_hint_x: 0.1

        Button:
            id: copy_down_button
            text: 'v'
            # size_hint_x: 0.25
            font_size: sp(16)
            on_release: root.copy_text_down()
        
        # DataManagerBodyText:
        #     text: 'Copy'
        #     font_size: sp(16)
        

<RateStructureRateTextInput>:
    multiline: False
    color: C(hex_black)
    font_size: sp(16)
    input_filter: 'float'
    write_tab: False
    on_focus: self.select_all() if self.focus else self.cancel_selection() 

<RateScheduleRow>:
    cols: 25
    spacing: 1
    row_force_default: True
    row_default_height: 28

    name: name

    DataManagerBodyText:
        id: name
        size_hint_x: 0.05
        color: C(hex_black)
        font_size: default_font

<RateScheduleTextInput>:
    size_hint_x: 1/24
    multiline: False
    background_color: self.get_background_color(self.text)
    foreground_color: self.get_foreground_color(self.text)
    font_size: sp(16)
    input_filter: 'int'
    write_tab: False
    on_focus: self.select_all() if self.focus else self.cancel_selection() 

<RateStructureScheduleGrid>:
    rows: 13
    row_force_default: True
    row_default_height: 28
    spacing: 1

    # GridLayout:
    #     cols: 24

    #     DataManagerBodyText:
    #         text: '1'
    #     DataManagerBodyText:
    #         text: '2'
    #     DataManagerBodyText:
    #         text: '3'
    #     DataManagerBodyText:
    #         text: '4'
    #     DataManagerBodyText:
    #         text: '5'
    #     DataManagerBodyText:
    #         text: '6'
    #     DataManagerBodyText:
    #         text: '7'
    #     DataManagerBodyText:
    #         text: '8'
    #     DataManagerBodyText:
    #         text: '9'
    #     DataManagerBodyText:
    #         text: '10'
    #     DataManagerBodyText:
    #         text: '11'
    #     DataManagerBodyText:
    #         text: '12'
    #     DataManagerBodyText:
    #         text: '13'
    #     DataManagerBodyText:
    #         text: '14'
    #     DataManagerBodyText:
    #         text: '15'
    #     DataManagerBodyText:
    #         text: '16'
    #     DataManagerBodyText:
    #         text: '17'
    #     DataManagerBodyText:
    #         text: '18'
    #     DataManagerBodyText:
    #         text: '19'
    #     DataManagerBodyText:
    #         text: '20'
    #     DataManagerBodyText:
    #         text: '21'
    #     DataManagerBodyText:
    #         text: '22'
    #     DataManagerBodyText:
    #         text: '23'
    #     DataManagerBodyText:
    #         text: '24'

<RateStructureDemandRateStructureScreen>:
    tou_period_table: tou_period_table
    flat_period_table: flat_period_table
    weekday_chart: weekday_chart
    weekend_chart: weekend_chart

    BoxLayout:
        orientation: 'vertical'
        padding: 10
        spacing: 5

        DataManagerTitle:
            size_hint_y: 0.05
            text: 'Verify the demand rate structure.'
        
        BoxLayout:
            orientation: 'horizontal'
            spacing: 10
            padding: (50, 0)
            size_hint_y: 0.90

            BoxLayout:
                orientation: 'vertical'
                size_hint_x: 0.3

                RateStructurePeriodTable:
                    id: tou_period_table
                    cols: 1
                    spacing: 2
                    size_hint_y: 0.5
                    padding: (25, 5)
                    row_force_default: True
                    row_default_height: 28
                    
                    GridLayout:
                        cols: 2
                        spacing: 5

                        DataManagerContentSubtitle:
                            size_hint_x: 0.3
                            # font_size: stnd_font
                            text: 'Period'
                        
                        DataManagerContentSubtitle:
                            size_hint_x: 0.7
                            # font_size: stnd_font
                            text: 'Time-of-Use Rate [$/kW]'
                
                RateStructurePeriodTable:
                    id: flat_period_table
                    cols: 1
                    spacing: 2
                    size_hint_y: 0.5
                    padding: (25, 5)
                    row_force_default: True
                    row_default_height: 28
                    
                    GridLayout:
                        cols: 2
                        spacing: 5

                        DataManagerContentSubtitle:
                            size_hint_x: 0.3
                            # font_size: stnd_font
                            text: 'Month'
                        
                        DataManagerContentSubtitle:
                            size_hint_x: 0.7
                            # font_size: stnd_font
                            text: 'Flat Rate [$/kW]'
            
            BoxLayout:
                orientation: 'vertical'
                size_hint_x: 0.1

                DataManagerContentTitle:
                    text: 'Weekday'
                    font_size: stnd_font
                
                DataManagerContentTitle:
                    text: 'Weekend'
                    font_size: stnd_font

            BoxLayout:
                orientation: 'vertical'
                # spacing: 5
                size_hint_x: 0.6

                BoxLayout:
                    orientation: 'vertical'
                    # spacing: 5
                    
                    RateStructureScheduleGrid:
                        id: weekday_chart
            
                    # RateScheduleChart:
                    #     size_hint_y: 0.9
                    #     id: weekday_chart
                        
                
                BoxLayout:
                    orientation: 'vertical'
                    # spacing: 5
                    
                    RateStructureScheduleGrid:
                        id: weekend_chart
            
                    # RateScheduleChart:
                    #     size_hint_y: 0.9
                    #     id: weekend_chart        
        
        AnchorLayout:
            anchor_y: 'center'
            anchor_x: 'center'
            size_hint_y: 0.05

            BoxLayout:
                orientation: 'horizontal'
                size_hint_x: 0.35
                spacing: 10

                TileButton:
                    size_hint_x: 0.5
                    background_color: C(hex_primary)
                    text: 'Previous'
                    on_release:
                        root.manager.transition.duration = BASE_TRANSITION_DUR/2
                        root.manager.transition.direction = 'right'
                        root.manager.current = root.manager.previous()

                TileButton:
                    size_hint_x: 0.5
                    background_color: C(hex_primary)
                    text: 'Continue'
                    on_release:
                        root.manager.transition.duration = BASE_TRANSITION_DUR
                        root.manager.transition.direction = 'left'
                        root.next_screen()

<RateStructureNetMeteringSaveScreen>:
    net_metering_1_toggle: net_metering_1_toggle
    net_metering_2_toggle: net_metering_2_toggle
    net_metering_sell_price_field: net_metering_sell_price_field
    save_name_field: save_name_field
    save_button: save_button

    BoxLayout:
        orientation: 'vertical'
        padding: 10
        spacing: 5

        DataManagerTitle:
            size_hint_y: 0.05
            text: 'Finishing up.'
        
        BoxLayout:
            orientation: 'vertical'
            spacing: 10
            padding: (450, 0)
            size_hint_y: 0.3

            DataManagerContentTitle:
                text: 'Net (energy) metering'
                size_hint_y: 0.1
            
            GridLayout:
                cols: 2
                spacing: 10
                size_hint_y: 0.9
                padding: (0, 25)

                GridLayout:
                    rows: 3
                    spacing: 10

                    ToggleTileButton:
                        id: net_metering_1_toggle
                        text: 'Net metering 1.0'
                        group: 'net_metering'
                    
                    DataManagerBodyText:
                        text: 'Energy is sold at the market energy price.'
                    
                    BoxLayout:
                        orientation: 'horizontal'
                        spacing: 5
                        opacity: 1.0 if net_metering_1_toggle.state == 'down' else 0.05

                        DataManagerBodyText:
                            text: 'sell price [$/kWh]'
                            size_hint_x: 0.6
                        
                        TextInput:
                            id: net_metering_sell_price_field
                            size_hint_x: 0.4
                            disabled: False if net_metering_1_toggle.state == 'down' else True
                
                GridLayout:
                    rows: 3
                    spacing: 10

                    ToggleTileButton:
                        id: net_metering_2_toggle
                        text: 'Net metering 2.0'
                        group: 'net_metering'
                        state: 'down'
                    
                    DataManagerBodyText:
                        text: 'Energy is sold at the time-of-use energy price.'
                    
                    BoxLayout:
                        orientation: 'vertical'
        
        BoxLayout:
            orientation: 'vertical'
            spacing: 10
            padding: (450, 0)
            size_hint_y: 0.6

            DataManagerContentTitle:
                text: 'Save rate structure'
                size_hint_y: 0.1
            
            BoxLayout:
                orientation: 'horizontal'
                spacing: 10
                size_hint_y: 0.1

                TextInput:
                    id: save_name_field
                    multiline: False
                    size_hint_x: 0.8
                    write_tab: False
                    hint_text: 'Enter a name for the rate structure'
                
                TileButton:
                    id: save_button
                    background_color: C(hex_primary)
                    size_hint_x: 0.2
                    text: 'Save'
                    on_release: root.save_rate_structure()
            
            BoxLayout:
                size_hint_y: 0.8
        
        AnchorLayout:
            anchor_y: 'center'
            anchor_x: 'center'
            size_hint_y: 0.05

            BoxLayout:
                orientation: 'horizontal'
                size_hint_x: 0.35
                spacing: 10

                TileButton:
                    size_hint_x: 0.5
                    background_color: C(hex_primary)
                    text: 'Previous'
                    on_release:
                        root.manager.transition.duration = BASE_TRANSITION_DUR/2
                        root.manager.transition.direction = 'right'
                        root.manager.current = root.manager.previous()

                TileButton:
                    size_hint_x: 0.5
                    background_color: C(hex_primary)
                    text: 'Start over'
                    on_release:
                        root.manager.transition.duration = BASE_TRANSITION_DUR
                        root.manager.transition.direction = 'left'
                        root.next_screen()

<RateStructureOpenEIapiHelp>:
    auto_dismiss: False
    size_hint: (0.52, 0.90)

    BoxLayout:
        orientation: 'vertical'
        spacing: 10
        padding: (25, 10)

        canvas.before:
            Color:
                rgb: C(hex_white)

            Rectangle:
                pos: self.pos
                size: self.size

        BoxLayout:
            orientation: 'vertical'
            size_hint_y: 0.23

            TitleTextBase:
                size_hint_y: 0.1
                text: 'Obtaining an OpenEI API key'
            
            BodyTextBase:
                size_hint_y: 0.9
                justify: True
                markup: True
                text: "You need an API key to access OpenEI data through the OpenEI API. This requires a quick registration. The guide here is only meant to serve as a quick reference; please refer to the Utility Rate Database page [ref=utility_rate_database_page][color=003359][u]here[/u][/color][/ref] for the most recent information."
                on_ref_press: webbrowser.open('https://openei.org/wiki/Utility_Rate_Database')
            
        ScrollView:
            size_hint_y: 0.7
            size_hint_x: 1
            scroll_type: ['bars', 'content']
            effect_cls: 'OpacityScrollEffect'

            BodyTextBase:
                #readonly: True
                markup: True
                size_hint: (1, None)
                text: "1) On the OpenEI Utility Rate Database [ref=utility_rate_database][color=003359][u]page[/u][/color][/ref], find the block titled 'Utility Rate Database API' and click on the 'utility rate API' link. \n\n 2) Under a block titled 'API Key,' click on the 'Get an API Key' button. \n\n 3) Fill out the form. Upon successful completion of the form, you should be given an alphanumeric API key on the page immediately. A copy of it should also be sent to the email address you provided. \n\n 4) Enter this key where requested in the QuESt Data Manager Utility Rate Structure Data menu and/or enter it into the appropriate section in the QuESt Data Manager settings panel to save for future use. \n\n 5) You're all set!"
                on_ref_press: webbrowser.open('https://openei.org/wiki/Utility_Rate_Database')

        AnchorLayout:
            anchor_x: 'right'
            anchor_y: 'bottom'
            padding: 5
            size_hint_y: 0.07

            TileButton:
                text: 'Got it, thanks!'
                #font_size: stnd_font
                size_hint_y: 1
                size_hint_x: 0.25
                on_release: root.dismiss()